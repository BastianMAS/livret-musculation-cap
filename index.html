<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Livret de Musculation</title>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#06b6d4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Musculation">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #06b6d4;
            --primary-dark: #0891b2;
            --secondary-color: #10b981;
            --accent-color: #fb923c;
            --bg-dark: #0f172a;
            --bg-medium: #1e293b;
            --text-light: #e2e8f0;
            --text-cyan: #67e8f9;
        }

        body.theme-blue {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --secondary-color: #06b6d4;
            --accent-color: #8b5cf6;
        }

        body.theme-green {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --secondary-color: #14b8a6;
            --accent-color: #84cc16;
        }

        body.theme-purple {
            --primary-color: #a855f7;
            --primary-dark: #9333ea;
            --secondary-color: #ec4899;
            --accent-color: #f43f5e;
        }

        body.theme-orange {
            --primary-color: #f97316;
            --primary-dark: #ea580c;
            --secondary-color: #fb923c;
            --accent-color: #fbbf24;
        }

        /* ===============================================
           STYLES MODE COACH - Historique éditable
           =============================================== */
        .coach-mode-banner {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            border-radius: 0.75rem;
            margin-bottom: 1rem;
        }

        .edit-btn, .delete-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .edit-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }

        .delete-btn {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .delete-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .edit-form {
            background: rgba(15, 23, 42, 0.9);
            border: 2px solid rgba(59, 130, 246, 0.3);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

            --primary-color: #f97316;
            --primary-dark: #ea580c;
            --secondary-color: #fb923c;
            --accent-color: #fbbf24;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, var(--bg-medium) 100%);
            min-height: 100vh;
            color: var(--text-light);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .text-white { color: #f1f5f9; }
        .text-cyan { color: var(--text-cyan); }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }

        .input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 0.75rem;
            color: #f1f5f9;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.75rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(245, 158, 11, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(100, 116, 139, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(239, 68, 68, 0.4);
        }

        .btn-link {
            background: transparent;
            color: var(--text-cyan);
            padding: 0.5rem 1rem;
        }

        .btn-link:hover {
            background: rgba(6, 182, 212, 0.1);
        }

        .flex { display: flex; }
        .justify-between { justify-content: space-between; }
        .items-center { align-items: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .grid { display: grid; }
        .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
        .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
        .text-center { text-align: center; }

        .user-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.4);
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.75rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: rgba(6, 182, 212, 0.1);
            color: var(--text-cyan);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .sub-tab-btn {
            padding: 0.6rem 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.6rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .sub-tab-btn:hover {
            background: rgba(6, 182, 212, 0.1);
            color: var(--text-cyan);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .sub-tab-btn.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .hidden { display: none; }

        .rm-history-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .rm-history-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .session-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(6, 182, 212, 0.2);
            border-color: rgba(6, 182, 212, 0.3);
        }

        .session-card.completed {
            border-color: rgba(16, 185, 129, 0.5);
            background: rgba(16, 185, 129, 0.05);
        }

        .session-completed-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .session-history-item {
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(148, 163, 184, 0.1);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge-force {
            background: rgba(249, 115, 22, 0.2);
            color: #fb923c;
            border: 1px solid rgba(249, 115, 22, 0.3);
        }

        .badge-endurance {
            background: rgba(6, 182, 212, 0.2);
            color: #67e8f9;
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .badge-équilibre {
            background: rgba(16, 185, 129, 0.2);
            color: #6ee7b7;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .avatar-upload {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: rgba(15, 23, 42, 0.8);
            border: 3px dashed rgba(6, 182, 212, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin: 0 auto;
            transition: all 0.3s ease;
            font-size: 2.5rem;
        }

        .avatar-upload:hover {
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-color);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .default-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
        }

        .muscle-btn {
            padding: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.75rem;
            color: #94a3b8;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-align: center;
        }

        .muscle-btn:hover {
            background: rgba(6, 182, 212, 0.1);
            color: var(--text-cyan);
            border-color: rgba(6, 182, 212, 0.3);
            transform: translateY(-2px);
        }

        .muscle-btn.selected {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .exercice-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .tip-box {
            background: rgba(6, 182, 212, 0.1);
            border-left: 4px solid var(--primary-color);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .content-section { margin-bottom: 2rem; }

        .exercise-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .exercise-card h4 {
            color: var(--text-cyan);
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .exercise-card ul {
            list-style: none;
            padding-left: 0;
        }

        .exercise-card ul li {
            color: var(--text-light);
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .exercise-card ul li:before {
            content: "✓";
            position: absolute;
            left: 0;
            color: #10b981;
            font-weight: bold;
        }

        .mobile-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .mobile-table th {
            background: rgba(6, 182, 212, 0.2);
            color: var(--text-cyan);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(6, 182, 212, 0.3);
        }

        .mobile-table td {
            padding: 1rem;
            color: var(--text-light);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .mobile-table tr:hover {
            background: rgba(6, 182, 212, 0.05);
        }

        .muscle-info-card {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .muscle-info-card h4 {
            color: var(--text-cyan);
            font-size: 1.3rem;
            margin-bottom: 1rem;
        }

        .muscle-info-section {
            margin-bottom: 1rem;
        }

        .muscle-info-section h5 {
            color: #10b981;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .muscle-info-section p {
            color: var(--text-light);
            line-height: 1.7;
            margin-bottom: 0.5rem;
        }

        .muscle-info-section ul {
            list-style: none;
            padding-left: 0;
        }

        .muscle-info-section ul li {
            color: var(--text-light);
            padding: 0.4rem 0;
            padding-left: 1.5rem;
            position: relative;
            line-height: 1.6;
        }

        .muscle-info-section ul li:before {
            content: "→";
            position: absolute;
            left: 0;
            color: var(--primary-color);
            font-weight: bold;
        }

        .timer-container {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
            border: 2px solid rgba(6, 182, 212, 0.4);
            border-radius: 1.5rem;
            padding: 2rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .timer-display {
            font-size: 5rem;
            font-weight: bold;
            color: var(--text-cyan);
            margin: 2rem 0;
            font-family: 'Courier New', monospace;
            text-shadow: 0 0 20px rgba(6, 182, 212, 0.5);
        }

        .timer-display.running {
            color: #10b981;
            animation: pulse 1s infinite;
        }

        .timer-display.finished {
            color: #ef4444;
            animation: blink 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .timer-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }

        .timer-preset {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 0.75rem;
            padding: 1rem 1.5rem;
            color: var(--text-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .timer-preset:hover {
            background: rgba(6, 182, 212, 0.2);
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3);
        }

        .timer-preset.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
        }

        .timer-input-group {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
            margin: 1rem 0;
        }

        .timer-input {
            width: 80px;
            padding: 0.5rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 0.5rem;
            color: #f1f5f9;
            font-size: 1rem;
            text-align: center;
        }

        .chrono-laps {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .lap-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            color: var(--text-light);
        }

        .lap-item:last-child {
            border-bottom: none;
        }

        .session-notes-area {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(148, 163, 184, 0.3);
            border-radius: 0.75rem;
            color: #f1f5f9;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
        }

        .session-notes-area:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .session-completion-modal {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1rem;
        }

        .charges-calculator {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(251, 146, 60, 0.2) 100%);
            border: 2px solid rgba(249, 115, 22, 0.4);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .charges-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .charges-table th {
            background: rgba(249, 115, 22, 0.3);
            color: #fb923c;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid rgba(249, 115, 22, 0.3);
        }

        .charges-table td {
            padding: 1rem;
            color: var(--text-light);
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .charges-table tr:hover {
            background: rgba(249, 115, 22, 0.1);
        }

        .charge-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #fb923c;
        }

        .search-container {
            position: sticky;
            top: 0;
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(10px);
            padding: 1rem;
            border-radius: 1rem;
            margin-bottom: 1.5rem;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            padding-left: 3rem;
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(6, 182, 212, 0.3);
            border-radius: 0.75rem;
            color: #f1f5f9;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.2rem;
            color: var(--primary-color);
        }

        .filter-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.75rem;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            background: rgba(6, 182, 212, 0.2);
            border: 1px solid rgba(6, 182, 212, 0.3);
            border-radius: 2rem;
            color: var(--text-cyan);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-chip:hover {
            background: rgba(6, 182, 212, 0.3);
            transform: translateY(-2px);
        }

        .filter-chip.active {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            border-color: transparent;
        }

        .no-results {
            text-align: center;
            padding: 3rem 1rem;
            color: #94a3b8;
        }

        .no-results-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .offline-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            z-index: 9999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .online-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #10b981;
            margin-right: 0.5rem;
            animation: pulse-indicator 2s infinite;
        }

        .offline-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            margin-right: 0.5rem;
        }

        @keyframes pulse-indicator {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chart-container {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-container canvas {
            max-height: 400px;
        }

        .theme-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .theme-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .theme-btn:hover {
            transform: scale(1.1);
        }

        .theme-btn.active {
            border-color: white;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
        }

        .theme-btn.theme-cyan { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
        .theme-btn.theme-blue { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
        .theme-btn.theme-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .theme-btn.theme-purple { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .theme-btn.theme-orange { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }



        .photo-item img {
            width: 100%;
            height: 300px;
            object-fit: cover;
            border-radius: 0.75rem;
            margin-bottom: 0.75rem;
        }


        .photo-placeholder:hover {
            border-color: var(--primary-color);
            transform: scale(1.02);
        }

        .badge-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .badge-item {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
        }

        .badge-item.unlocked {
            border-color: var(--primary-color);
            background: rgba(6, 182, 212, 0.1);
        }

        .badge-item.locked {
            opacity: 0.4;
        }

        .badge-icon {
            font-size: 3rem;
            margin-bottom: 0.5rem;
        }

        .badge-item.unlocked .badge-icon {
            animation: bounce 1s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(15, 23, 42, 0.8);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            transition: width 0.5s ease;
        }

        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-3 { grid-template-columns: 1fr; }
            .container { padding: 0.5rem; }
            .card { padding: 1rem; border-radius: 1rem; }
            .flex { flex-direction: column; }
            .tab-btn, .sub-tab-btn { width: 100%; text-align: center; }
            .timer-display { font-size: 3rem; }
            .badge-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="offline-banner" class="hidden"></div>
    <div id="app"></div>
    <script>// PARTIE 2/4 - DONNÉES ET SÉCURITÉ
        
        // SYSTÈME DE STOCKAGE LOCAL
                // ===============================================
        // MODE COACH - Variable globale
        // ===============================================
        let IS_COACH_MODE = false;

        const storage = {
            save: (key, value) => {
                try {
                    const fullKey = `user-${app.currentUser}-${key}`;
                    const jsonValue = typeof value === 'string' ? value : JSON.stringify(value);
                    localStorage.setItem(fullKey, jsonValue);
                    return true;
                } catch (e) {
                    console.error('Erreur de sauvegarde:', e);
                    return false;
                }
            },
            
            get: (key, isGlobal = false) => {
                try {
                    const fullKey = isGlobal ? key : `user-${app.currentUser}-${key}`;
                    const value = localStorage.getItem(fullKey);
                    return {
                        exists: value !== null,
                        value: value
                    };
                } catch (e) {
                    console.error('Erreur de lecture:', e);
                    return { exists: false, value: null };
                }
            }
        };

        // SYSTÈME DE SÉCURITÉ PAR CODE D'ACCÈS
        const securite = {
            classes: {
                "2_CAP_ECP_25_26": {
                    code: "2CAPECP25",
                    nom: "2 CAP ECP 25-26",
                    eleves: [
                        "AZOULAI EDEN",
                        "BORRALHO EMMA",
                        "CARRILHO RITO LEANA",
                        "DE MATOS AMBRE",
                        "FAUCHER CAMILLE",
                        "FAUSTIN NINA",
                        "HOUËT LORELINE",
                        "LANDON LOUANE",
                        "MARCHIONE LAURA",
                        "PAPUCHON MELODIE",
                        "SIMON DAPHNE",
                        "STANKOVIC NINA",
                        "TASSILLY LENA",
                        "TRAN ALICE",
                        "VU--NGUYEN LEA"
                    ]
                },
                "1_CAP_ECP_25_26": {
                    code: "1CAPECP25",
                    nom: "1 CAP ECP 25-26",
                    eleves: [
                        "ALVAREZ ELUNA",
                        "AOUSSAT SONIA",
                        "ARAPOVIC NINA",
                        "AZZOUZ NOORE",
                        "CEBOTARI IURIANA",
                        "DA SILVA LEVIEUX JOY",
                        "DENIS DUPART MAELYS",
                        "FERNANDES-LEITAO KESSY",
                        "GUILLAUME SANOU ALANA",
                        "OLIVEIRA THERY",
                        "OSI LINA",
                        "ROUSSEL KLARA",
                        "STANKOVIC ALEXANDRA",
                        "WESPISER IZAGONOLA ANIA"
                    ]
                },
                "PROFESSEUR_25_26": {
                    code: "PROFCAB25",
                    nom: "PROFESSEUR 25-26",
                    eleves: [
                        "MAS BASTIAN",
                        "PEREIRA CEDRIC",
                        "AMAND ANAIS",
                        "THENEZAY URSULA",
                        "HASSLER SOLENE",
                        "RORTAIS MORGAN",
                        "RAULT BENOIT"
                    ]
                },
                "GROUPE_PRO_GOLF_25_26": {
                    code: "GOLFPRO25",
                    nom: "GROUPE PRO GOLF 25-26",
                    eleves: [
                        "BOULET THEO",
                        "RECROSIO THOMAS",
                        "FRANQUET PAUL",
                        "GRIFFAUT MARINE"
                    ]
                },
                "GROUPE_GOLF_AMATEUR_25_26": {
                    code: "GOLFAM25",
                    nom: "GROUPE GOLF AMATEUR 25-26",
                    eleves: [
                        "LOPEZ JOSS",
                        "LOPEZ  NEIL",
                        "DOSSOU KOKO MATHIAS",
                        "GODIN ALEXANDRE"
                    ]
                },
                "2_OPTION_EPS_25_26": {
                    code: "2OEPS25",
                    nom: "2 OPTION EPS 25-26",
                    eleves: [
                        "AIGLE PAUL",
                        "BASSUKA YAELIS",
                        "BAUDIN MARKUS",
                        "BERTHONNET MAXIME",
                        "DE BARROS SEMEDO THEO",
                        "FEUTRIE AGATHE",
                        "GENDRE HELENE",
                        "GUILLOUX BRIEUC",
                        "HENG JAYDEN-PAUL",
                        "LALLEMENT--BONNIN ORIANE",
                        "PATARD MILAN",
                        "PHAM LUCAS",
                        "PRIGENT LILOU",
                        "PRUDHOMME CLARA",
                        "SOUSA MAELYS",
                        "STRAPPE SOFIA"
                    ]
                },
                "COACH_MODE_25_26": {
                    code: "COACH2025",
                    nom: "MODE COACH 25-26",
                    eleves: ["COACH"]                }
            },

            codeActuel: null,
            
            verifierCode: function(code) {
                for (let classe in this.classes) {
                    if (this.classes[classe].code === code) {
                        this.codeActuel = classe;
                        // Activer le mode coach si c'est le code COACH
                        if (code === "COACH2025") {
                            IS_COACH_MODE = true;
                        }
                        return true;
                    }
                }
                return false;
            },
            
            verifierUtilisateur: function(nom) {
                if (!this.codeActuel) return false;
                const classe = this.classes[this.codeActuel];
                if (!classe) return false;
                
                // Pour le mode coach, accepter n'importe quel nom
                if (IS_COACH_MODE) return true;
                
                const nomNormalise = nom.toLowerCase().trim();
                return classe.eleves.some(eleve => 
                    eleve.toLowerCase().trim().includes(nomNormalise) || 
                    nomNormalise.includes(eleve.toLowerCase().trim())
                );
            },
            
            getNomClasse: function() {
                if (!this.codeActuel) return "Classe";
                return this.classes[this.codeActuel].nom;
            },
            
            validerCode: function() {
                if (this.codeActuel) {
                    localStorage.setItem('code-valide', 'true');
                    localStorage.setItem('classe-active', this.codeActuel);
                    if (IS_COACH_MODE) {
                        localStorage.setItem('coach-mode', 'true');
                    }
                }
            },
            
            estDejaConnecte: function() {
                const codeValide = localStorage.getItem('code-valide');
                const classeActive = localStorage.getItem('classe-active');
                const coachMode = localStorage.getItem('coach-mode');
                if (codeValide === 'true' && classeActive) {
                    this.codeActuel = classeActive;
                    if (coachMode === 'true') {
                        IS_COACH_MODE = true;
                    }
                    return true;
                }
                return false;
            },
            
            revoquerAcces: function() {
                localStorage.removeItem('code-valide');
                localStorage.removeItem('classe-active');
                localStorage.removeItem('coach-mode');
                IS_COACH_MODE = false;
                this.codeActuel = null;
            }
        };

        // DONNÉES DES COURS (version condensée pour économiser l'espace)
        const coursData = {
            principes: [
                {
                    titre: "Principe de Surcharge Progressive",
                    contenu: "Pour progresser, il faut augmenter progressivement la charge, le volume ou l'intensité de l'entraînement.",
                    conseils: ["Augmenter la charge de 2-5%", "Ajouter répétitions/séries", "Varier les exercices", "Noter performances"]
                },
                {
                    titre: "Principe de Spécificité",
                    contenu: "Les adaptations sont spécifiques au type d'entraînement effectué.",
                    conseils: ["Adapter mobile à objectif", "Rester cohérent 8-12 semaines", "Varier mobiles sur l'année", "Privilégier poly-articulaires"]
                },
                {
                    titre: "Principe de Récupération",
                    contenu: "La progression se fait pendant la récupération. Un muscle a besoin de 48-72h pour récupérer.",
                    conseils: ["48h entre séances même muscle", "7-9h sommeil", "1.5-2L eau/jour", "Écouter son corps"]
                }
            ],

            mobiles: [
                {
                    nom: "FORCE MAXIMALE",
                    color: "#ef4444",
                    definition: "Mobile visant à développer la capacité à produire la force maximale possible en une seule répétition. Travail sur le système nerveux (recrutement des unités motrices) et adaptation neuromusculaire.",
                    objectif: "Soulever la charge la plus lourde possible, augmenter le 1RM",
                    charge: "85-100% du 1RM",
                    repetitions: "1-5 répétitions",
                    series: "4-6 séries",
                    repos: "3-5 minutes (récupération complète)",
                    tempo: "Explosif en concentrique, contrôlé en excentrique",
                    avantages: ["Augmentation significative de la force maximale", "Amélioration de la coordination neuromusculaire", "Gains de confiance et dépassement mental", "Base solide pour tous les autres mobiles"],
                    inconvenients: ["Fatigue nerveuse importante", "Risque de blessure si technique incorrecte", "Peu d'effet sur l'hypertrophie directe", "Nécessite une récupération longue"],
                    public: "Adhérent confirmé à Expert",
                    exemple: "Développé Couché (Pectoraux) : 5 séries de 3 répétitions à 90% de 1RM. Si 1RM = 100kg → 90kg × 3 reps × 5 séries. Repos : 4 minutes entre séries. Focus : Explosivité sur la montée, contrôle sur la descente (3 secondes).",
                    formes: ["Charges libres", "Poly-articulaires", "Pyramide ascendante", "Rest-pause"]
                },
                {
                    nom: "FORCE EXPLOSIVE (PUISSANCE)",
                    color: "#f97316",
                    definition: "Mobile développant la capacité à produire une force maximale dans un temps minimal. Combinaison de la force et de la vitesse (Puissance = Force × Vitesse). Sollicitation importante des fibres rapides de type IIx.",
                    objectif: "Améliorer la vitesse d'exécution, l'explosivité, la détente",
                    charge: "30-60% du 1RM",
                    repetitions: "3-6 répétitions explosives",
                    series: "4-6 séries",
                    repos: "2-4 minutes",
                    tempo: "Le plus explosif possible en concentrique",
                    avantages: ["Développement de la puissance athlétique", "Amélioration de la vitesse de contraction", "Transfert direct vers les performances sportives", "Augmentation de la détente verticale/horizontale"],
                    inconvenients: ["Technique très importante (risque de blessure)", "Fatigue du système nerveux", "Nécessite un équipement adapté (souvent)", "Peu d'effet sur la masse musculaire"],
                    public: "Adhérent confirmé à Expert",
                    exemple: "Squat Jump (Quadriceps/Fessiers) : 5 séries de 5 squat jumps à 40% de 1RM Squat. Si 1RM = 150kg → 60kg × 5 sauts × 5 séries. Repos : 3 minutes. Consigne : Descente contrôlée, explosion maximale, réception souple.",
                    formes: ["Pliométrie", "Charges explosives", "Box jumps", "Olympic lifts"]
                },
                {
                    nom: "HYPERTROPHIE (MASSE MUSCULAIRE)",
                    color: "#3b82f6",
                    definition: "Mobile axé sur l'augmentation du volume musculaire (hypertrophie myofibrillaire et sarcoplasmique). Travail sur le temps sous tension, le stress métabolique et les micro-lésions musculaires qui stimulent la croissance.",
                    objectif: "Prise de masse musculaire, développement du volume",
                    charge: "65-80% du 1RM",
                    repetitions: "6-12 répétitions",
                    series: "3-5 séries",
                    repos: "60-90 secondes",
                    tempo: "Contrôlé (3-1-1 ou 4-0-2)",
                    avantages: ["Prise de masse musculaire visible", "Équilibre force/volume optimal", "Amélioration de la définition musculaire", "Bon compromis pour développement général"],
                    inconvenients: ["Nécessite une alimentation adaptée (surplus calorique)", "Volume d'entraînement important", "Fatigue métabolique (brûlures, courbatures)", "Progrès plus lents que sur la force pure"],
                    public: "Débutant à Expert",
                    exemple: "Développé Incliné Haltères (Haut des Pectoraux) : 4 séries de 10 répétitions à 75% de 1RM. Si 1RM = 40kg/haltère → 30kg × 10 reps × 4 séries. Repos : 75 sec. Tempo : 3 sec descente, 1 sec pause, 1 sec montée.",
                    formes: ["Drop sets", "Supersets", "Tempo contrôlé", "Volume training"]
                },
                {
                    nom: "ENDURANCE DE FORCE",
                    color: "#a855f7",
                    definition: "Mobile visant à maintenir un niveau de force élevé sur une durée prolongée. Combinaison de force et d'endurance, développant la résistance à la fatigue tout en maintenant des charges significatives.",
                    objectif: "Maintenir la performance sur la durée, résistance à la fatigue",
                    charge: "60-75% du 1RM",
                    repetitions: "12-20 répétitions",
                    series: "3-4 séries",
                    repos: "60-90 secondes",
                    tempo: "Régulier et soutenu",
                    avantages: ["Amélioration de la capacité de travail musculaire", "Bon compromis force/endurance", "Préparation physique pour sports d'endurance", "Développement de la résistance mentale"],
                    inconvenients: ["Moins efficace pour force pure ou masse", "Fatigue métabolique importante (acide lactique)", "Nécessite une bonne condition physique de base", "Sensation de brûlure importante"],
                    public: "Adhérent à Expert",
                    exemple: "Leg Press (Quadriceps/Fessiers) : 4 séries de 15 répétitions à 70% de 1RM. Si 1RM = 300kg → 210kg × 15 reps × 4 séries. Repos : 75 sec. Consigne : Rythme constant, amplitude complète, respiration régulière.",
                    formes: ["Séries longues", "Pyramide descendante", "Circuits résistance", "Complexes"]
                },
                {
                    nom: "ENDURANCE MUSCULAIRE",
                    color: "#10b981",
                    definition: "Mobile orienté vers la capacité à maintenir un effort musculaire prolongé avec des charges légères. Développement des capacités aérobies du muscle, augmentation des capillaires et de l'endurance locale.",
                    objectif: "Définition musculaire, endurance locale, tonification",
                    charge: "40-60% du 1RM",
                    repetitions: "20-30+ répétitions",
                    series: "2-4 séries",
                    repos: "30-60 secondes",
                    tempo: "Rapide et continu",
                    avantages: ["Excellente définition musculaire (sèche)", "Amélioration de l'endurance cardiovasculaire", "Faible risque de blessure", "Brûlage calorique important", "Récupération rapide"],
                    inconvenients: ["Peu d'effet sur la force ou la masse", "Sensation de brûlure très importante", "Peut devenir monotone (volume élevé)", "Nécessite une concentration mentale"],
                    public: "Débutant à Adhérent",
                    exemple: "Curl Biceps Haltères (Biceps) : 3 séries de 25 répétitions à 50% de 1RM. Si 1RM = 20kg/haltère → 10kg × 25 reps × 3 séries. Repos : 45 sec. Consigne : Rythme soutenu, sans pause, rechercher la congestion.",
                    formes: ["Circuit training", "HIIT musculation", "Burn sets", "AMRAP"]
                },
                {
                    nom: "PERSONNALISÉ",
                    color: "#a855f7",
                    definition: "Mobile libre permettant de définir ses propres paramètres selon ses objectifs spécifiques, son niveau, ou des besoins particuliers (rééducation, sport spécifique, préparation physique).",
                    objectif: "Adaptation totale aux besoins individuels",
                    charge: "Au choix",
                    repetitions: "Au choix",
                    series: "Au choix",
                    repos: "Au choix",
                    tempo: "Au choix",
                    avantages: ["Flexibilité totale", "Adaptation à tout objectif", "Possibilité de créer des méthodes hybrides", "Progression personnalisée"],
                    inconvenients: ["Nécessite une bonne connaissance de l'entraînement", "Risque d'incohérence si mal configuré", "Manque de structure pour débutants"],
                    public: "Adhérent confirmé à Expert",
                    exemple: "Méthode 5-3-1 sur Squat : Semaine 1 (5 reps à 65%, 75%, 85%), Semaine 2 (3 reps à 70%, 80%, 90%), Semaine 3 (5/3/1 reps à 75%, 85%, 95%), Semaine 4 (Deload).",
                    formes: ["Toutes méthodes", "Programmes spécifiques", "Périodisation", "Auto-régulation"]
                }
            ],

            typesContraction: [
                {type: "Concentrique", definition: "Muscle se raccourcit (phase positive)", exemple: "Monter la barre", mobile: "Force et puissance"},
                {type: "Excentrique", definition: "Muscle s'allonge sous tension (phase négative)", exemple: "Descendre la barre", mobile: "Hypertrophie"},
                {type: "Isométrique", definition: "Contraction statique sans mouvement", exemple: "Gainage planche", mobile: "Endurance et stabilisation"},
                {type: "Pliométrique", definition: "Contraction rapide après un étirement brusque du muscle. Enchaînement rapide d'une phase excentrique (étirement) puis concentrique (raccourcissement) qui utilise le réflexe myotatique et l'énergie élastique stockée.", exemple: "Descente rapide en squat jump puis saut explosif immédiat", mobile: "Force explosive et puissance"}
            ],

            formesEntrainement: [
                {
                    nom: "SÉRIES DROITES (STRAIGHT SETS)",
                    definition: "Forme classique d'entraînement où l'on effectue le même nombre de répétitions avec la même charge sur toutes les séries. Base de la musculation traditionnelle.",
                    structure: "X séries × Y répétitions à Z kg",
                    avantages: ["Simple à comprendre et appliquer", "Facile à suivre et noter", "Excellent pour la progression linéaire", "Permet de maintenir la charge constante"],
                    inconvenients: ["Peut devenir monotone", "Fatigue progressive affecte les dernières séries", "Peu de variation de stimulus"],
                    public: "Débutant à Adhérent - Idéal pour apprendre",
                    exemple: "Développé Couché : 4 séries de 8 répétitions à 80kg. Repos : 90 secondes entre séries."
                },
                {
                    nom: "SÉRIES PYRAMIDALES",
                    definition: "Variation de charge et/ou de répétitions d'une série à l'autre. Peut être ascendante (charge augmente, reps diminuent), descendante (charge diminue, reps augmentent) ou en double pyramide.",
                    structure: "Charge et répétitions variables selon progression",
                    avantages: ["Stimulation musculaire variée", "Permet d'atteindre intensités maximales et volumes élevés", "Excellent pour force + hypertrophie", "Moins monotone"],
                    inconvenients: ["Plus complexe à programmer", "Nécessite plusieurs poids/réglages", "Fatigue importante si mal dosée", "Calculs nécessaires"],
                    public: "Adhérant à Expert",
                    exemple: "Squat Double Pyramide : 80kg×12, 100kg×10, 120kg×8, 140kg×6 (apex), puis 120kg×8, 100kg×10, 80kg×12. Repos : 2-3 min."
                },
                {
                    nom: "SÉRIES DÉGRESSIVES (DROP SETS)",
                    definition: "Enchaînement de plusieurs séries du même exercice sans temps de repos, en réduisant progressivement la charge à chaque palier. Pousse le muscle à l'échec musculaire répété.",
                    structure: "Charge de départ → Réduction 20-30% → Réduction 20-30%",
                    avantages: ["Congestion musculaire maximale", "Gain de temps (pas de repos)", "Excellent pour hypertrophie", "Intensité mentale importante", "Brûlage calorique élevé"],
                    inconvenients: ["Très éprouvant (fatigue extrême)", "Nécessite changement rapide de poids", "Récupération longue nécessaire", "Risque de surentraînement si mal dosé"],
                    public: "Adhérant confirmé à Expert - À utiliser avec parcimonie",
                    exemple: "Leg Extension : 80kg×12 (échec) → immédiatement 60kg×10 (échec) → immédiatement 45kg×8+ (échec total). Aucun repos entre phases."
                },
                {
                    nom: "SUPERSETS (SÉRIES ENCHAÎNÉES)",
                    definition: "Enchaînement de 2 exercices différents sans temps de repos. Peut cibler le même muscle (superset agoniste) ou des muscles opposés (superset antagoniste).",
                    structure: "Exercice A → immédiatement Exercice B → Repos",
                    avantages: ["Gain de temps considérable (50%)", "Congestion musculaire intense", "Amélioration cardiovasculaire", "Brûlage calorique élevé", "Variation du stimulus"],
                    inconvenients: ["Nécessite 2 postes disponibles (en salle)", "Très fatigant", "Difficile de maintenir charges lourdes", "Technique peut se dégrader"],
                    public: "Adhérant à Expert",
                    exemple: "Superset Bras : A) Curl Barre 40kg×10 → 0 sec repos → B) Barre au Front 30kg×12 → Repos 90 sec. Répéter 4 fois."
                },
                {
                    nom: "SÉRIES EN REST-PAUSE",
                    definition: "Série prolongée avec micro-pauses pour permettre récupération partielle et continuer au-delà de l'échec initial. Technique d'intensification qui pousse l'endurance de force.",
                    structure: "Série échec → Pause 10-20 sec → Reprise 2-4 reps → Répéter",
                    avantages: ["Dépasser l'échec musculaire", "Augmentation du volume total", "Excellent pour hypertrophie", "Sollicitation maximale des fibres", "Intensité mentale"],
                    inconvenients: ["Très éprouvant nerveusement", "Nécessite une bonne technique stable", "Récupération longue", "Risque de blessure en fin de série"],
                    public: "Expert uniquement - Phases d'intensification",
                    exemple: "Développé Militaire 24kg : 8 reps (échec) → 15 sec pause → 4 reps (échec) → 15 sec pause → 2 reps → 15 sec pause → 1 rep. Total : 15 reps."
                },
                {
                    nom: "CIRCUIT TRAINING / HIIT MUSCULATION",
                    definition: "Enchaînement de plusieurs exercices (4-8) ciblant différents groupes musculaires avec temps de repos minimal. Peut être organisé en circuit (1 tour de tous les exos) ou en HIIT (travail/repos structuré).",
                    structure: "Exercice 1 → 2 → 3 → 4 → ... → Repos → Répéter",
                    avantages: ["Excellent pour condition physique générale", "Brûlage calorique maximal", "Travail cardiovasculaire + musculaire", "Gain de temps important", "Ludique et varié"],
                    inconvenients: ["Peu efficace pour force maximale", "Nécessite beaucoup d'espace/matériel", "Technique peut être négligée (fatigue)", "Difficile en salle bondée"],
                    public: "Débutant à Adhérant",
                    exemple: "Circuit Full Body 6 exercices : 45 sec travail / 15 sec transition. Squat → Pompes → Fentes → Rowing → Planche → Burpees. 3 tours, 2 min repos entre tours."
                }
            ],

            hygiene: {
                avant: [
                    {titre: "Échauffement (10-15 min)", contenu: "Cardio léger puis mouvements dynamiques spécifiques."},
                    {titre: "Hydratation", contenu: "300-500ml d'eau 2h avant l'entraînement."},
                    {titre: "Alimentation", contenu: "Repas 2-3h avant avec glucides et protéines."}
                ],
                pendant: [
                    {titre: "Technique et Respiration", contenu: "Toujours privilégier la technique. Expirer pendant l'effort."},
                    {titre: "Hydratation Continue", contenu: "Petites gorgées toutes les 15-20 minutes."},
                    {titre: "Écoute du Corps", contenu: "Distinguer douleur musculaire de douleur articulaire."}
                ],
                apres: [
                    {titre: "Retour au Calme", contenu: "5-10 min cardio léger pour récupération."},
                    {titre: "Étirements", contenu: "30 secondes par muscle, étirement confortable."},
                    {titre: "Nutrition Post-Entraînement", contenu: "20-30g protéines + glucides dans les 2h."},
                    {titre: "Sommeil", contenu: "7-9h de qualité pour récupération optimale."}
                ]
            },

            anatomie: {
                "Pectoraux": {role: "Adduction, flexion et rotation interne épaule. Mouvements de poussée.", insertions: ["Clavicule, sternum → Humérus", "3 faisceaux: haut, milieu, bas"]},
                "Grand Dorsal": {role: "Extension, adduction épaule. Forme en V du dos.", insertions: ["Vertèbres, crête iliaque → Humérus", "Travaillé en traction"]},
                "Trapèzes": {role: "Élévation, abaissement, rétraction omoplates. Posture.", insertions: ["3 faisceaux: supérieur, moyen, inférieur", "Crâne, vertèbres → Omoplate"]},
                "Deltoïdes": {role: "Abduction, flexion, extension épaule. Largeur épaules.", insertions: ["3 faisceaux: antérieur, moyen, postérieur", "Clavicule, omoplate → Humérus"]},
                "Biceps": {role: "Flexion coude et supination avant-bras.", insertions: ["2 chefs depuis omoplate → Radius", "Synergiste: brachial"]},
                "Triceps": {role: "Extension coude. 2/3 du volume du bras.", insertions: ["3 chefs: long, latéral, médial", "Omoplate, humérus → Ulna"]},
                "Quadriceps": {role: "Extension genou, flexion hanche. Plus puissant muscle.", insertions: ["4 chefs: droit fémoral + 3 vastes", "Bassin, fémur → Rotule → Tibia"]},
                "Ischio-jambiers": {role: "Flexion genou, extension hanche. Antagonistes quadriceps.", insertions: ["3 muscles", "Ischion → Tibia, fibula"]},
                "Fessiers": {role: "Extension, abduction, rotation hanche. Muscle le plus puissant.", insertions: ["Grand, moyen, petit fessier", "Iliaque, sacrum → Fémur"]},
                "Adducteurs": {role: "Adduction de la hanche (rapproche jambes). Stabilisation du bassin.", insertions: ["5 muscles: court, long, grand, pectiné, gracile", "Pubis → Fémur"]}
            },

            exercicesPectoraux: [
                {nom: "Développé Couché", description: "Exercice roi pectoraux. Allongé, descendre/pousser barre.", technique: ["Omoplates plaquées", "Barre niveau tétons", "Coudes 45°", "Pieds ancrés"], variantes: ["Incliné (haut)", "Décliné (bas)", "Haltères"], video: "https://www.youtube.com/watch?v=sRuKSZLcmWM"},
                {nom: "Développé Incliné", description: "Variante sur banc incliné, cible haut des pectoraux.", technique: ["Banc à 30-45°", "Omoplates serrées", "Descente contrôlée", "Pousser explosif"], variantes: ["Haltères", "Barre", "Smith machine"], video: "https://www.youtube.com/watch?v=UogqSjfNQwE"},
                {nom: "Écarté Couché", description: "Allongé, bras écartés, descendre puis ramener.", technique: ["Légère flexion coudes", "Étirement pectoraux", "Pas plus bas que banc", "Arc de cercle"], variantes: ["Incliné", "Poulie", "Pec deck"], video: "https://www.youtube.com/shorts/FbzTlGj2Qbw"},
                {nom: "Poulies Vis-à-vis", description: "Debout entre poulies, ramener mains devant poitrine.", technique: ["Légère inclinaison avant", "Coudes semi-fléchis", "Contraction pic", "Contrôler retour"], variantes: ["Bas vers haut", "Haut vers bas", "Horizontal"], video: "https://www.youtube.com/watch?v=Puu3zs0hATI"},
                {nom: "Dips", description: "Entre barres, descendre puis remonter.", technique: ["Penché=pecs, droit=triceps", "90° minimum", "Coudes près corps", "Contrôler"], variantes: ["Lestés", "Assistés", "Sur banc"], video: "https://www.youtube.com/shorts/ZE1LMMVYgpQ"}
            ],

            exercicesDos: [
                {nom: "Tirage Vertical", description: "Assis machine, tirer barre vers poitrine.", technique: ["Penché 20-30°", "Vers haut pectoraux", "Contracter omoplates", "Pas derrière nuque"], variantes: ["Prise large", "Serrée", "Neutre"], video: "https://www.youtube.com/shorts/XClPH0DfdFI"},
                {nom: "Tirage Horizontal", description: "Assis, tirer poignées vers abdos.", technique: ["Dos droit", "Coudes le long du corps", "Serrer omoplates", "Poitrine sortie"], variantes: ["Prise neutre", "Pronation", "Supination"], video: "https://www.youtube.com/shorts/hnNjcQI9ZMU"},
                {nom: "Traction", description: "Suspendu, se hisser menton au-dessus barre.", technique: ["Prise large", "Coudes vers bas/arrière", "Poitrine vers barre", "Descente contrôlée"], variantes: ["Pronation (dur)", "Supination (facile)", "Assistée"], video: "https://www.youtube.com/watch?v=bxguzp1DCFw"},
                {nom: "Rowing Barre", description: "Penché, tirer barre vers ventre.", technique: ["Dos droit", "Tirer vers nombril", "Coudes le long", "Contracter omoplates"], variantes: ["Yates", "Haltères", "T-barre"], video: "https://www.youtube.com/watch?v=69frLpCDGkc"},
                {nom: "Rowing Haltère", description: "Un genou sur banc, tirer haltère vers hanche.", technique: ["Dos parallèle au sol", "Coude le long du corps", "Tirer vers hanche", "Ne pas rotation tronc"], variantes: ["2 bras simultanés", "Debout penché", "Sur banc incliné"], video: "https://www.youtube.com/watch?v=jyrudAO4Rxc"},
                {nom: "Face Pull Assis", description: "Tirer corde vers visage, coudes hauts.", technique: ["Coudes au-dessus mains", "Tirer vers front", "Écarter corde fin", "Trapèzes+deltoïdes arrière"], variantes: ["Debout", "Un genou au sol", "Poulie haute/basse"], video: "https://www.youtube.com/shorts/PvmQURl5zKY"},
                {nom: "Extension Lombaire", description: "Sur banc à lombaires, descendre et remonter tronc.", technique: ["Mains derrière tête", "Descente contrôlée", "Dos droit", "Contracter fessiers/lombaires"], variantes: ["Lesté", "Sur Swiss ball", "Good morning"], video: "https://www.youtube.com/watch?v=uIsMsi5ui8A"}
            ],

            exercicesEpaules: [
                {nom: "Développé Militaire", description: "Debout/assis, pousser barre au-dessus tête.", technique: ["Gainage fort", "Coudes devant barre", "Tête en avant fin", "Pas cambrer"], variantes: ["Haltères", "Arnold", "Nuque (attention)"], video: "https://www.youtube.com/watch?v=NQ-JJYay1TM"},
                {nom: "Élévations Latérales", description: "Lever haltères côtés jusqu'à épaules.", technique: ["Coudes fléchis", "Hauteur épaules", "Contrôler descente", "Rotation légère"], variantes: ["Poulie", "Assis", "Un bras"], video: "https://www.youtube.com/watch?v=-_XE4qbV7Yw"},
                {nom: "Face Pull Deltoïdes", description: "Tirer corde vers visage pour deltoïdes postérieurs.", technique: ["Coudes hauts", "Séparer corde", "Vers oreilles", "Contraction arrière épaules"], variantes: ["Poulie haute", "Poulie basse", "Élastique"], video: "https://www.youtube.com/watch?v=a9AaQh1dtRs"}
            ],

            exercicesBras: [
                {nom: "Larry Scott (Pupitre)", description: "Assis, bras sur pupitre, curl barre.", technique: ["Coudes sur pupitre", "Amplitude complète", "Pas décoller coudes", "Contraction pic"], variantes: ["Haltères", "Barre EZ", "Un bras"], video: "https://www.youtube.com/watch?v=8MSRc2_b2d4"},
                {nom: "Curl Barre", description: "Debout, fléchir coudes monter barre.", technique: ["Coudes fixes", "Pas balancer", "Contracter biceps", "Descente contrôlée"], variantes: ["Haltères", "Marteau", "Barre EZ"], video: "https://www.youtube.com/watch?v=ndg4oTdo4Xs"},
                {nom: "Curl Haltère", description: "Debout, alterner ou simultané, monter haltères.", technique: ["Rotation avant-bras", "Coudes fixes", "Contraction supination", "Pas d'élan"], variantes: ["Alternés", "Simultanés", "Marteau", "Assis incliné"], video: "https://www.youtube.com/watch?v=5S8x-9SvQ5w"},
                {nom: "Barre au Front", description: "Allongé, descendre barre vers front, étendre.", technique: ["Coudes fixes pointés plafond", "Vers front/cheveux", "Contrôle", "Ne pas bouger épaules"], variantes: ["Haltères", "Poulie haute", "Barre EZ"], video: "https://www.youtube.com/watch?v=e3X7IFQEZrc"},
                {nom: "Extension Corde", description: "Poulie haute, descendre corde en écartant.", technique: ["Coudes fixes le long", "Écarter corde bas", "Extension complète", "Contraction pic"], variantes: ["Barre", "Un bras", "Prise inversée"], video: "https://www.youtube.com/watch?v=TDCmyWi5iyU"},
                {nom: "Extension Haltère", description: "Debout/assis, haltère derrière tête, étendre.", technique: ["Coudes près oreilles", "Descente profonde", "Extension complète", "Gainage"], variantes: ["2 bras", "Un bras", "Allongé"], video: "https://www.youtube.com/watch?v=rFNQv9eae6I"}
            ],

            exercicesBasDuCorps: [
                {nom: "Squat", description: "Roi du bas du corps. Descendre fléchir hanches/genoux.", technique: ["Pieds largeur épaules", "Fesses en arrière", "Genoux axe pieds", "Dos droit"], variantes: ["Front", "Bulgare", "Goblet"], videos: ["https://www.youtube.com/watch?v=Bjfefk24UXM", "https://www.youtube.com/watch?v=-De1zvmtj8c"]},
                {nom: "Soulevé de Terre", description: "Saisir barre sol, se redresser.", technique: ["Dos droit", "Pousser talons", "Hanches/épaules ensemble", "Barre le long jambes"], variantes: ["Roumain", "Sumo", "Trap bar"], video: "https://www.youtube.com/watch?v=fne6CyCgGDw"},
                {nom: "Fente Bulgare", description: "Pied arrière surélevé, descendre en fente.", technique: ["Genou avant axe cheville", "Descente verticale", "Poids sur talon avant", "Équilibre"], variantes: ["Haltères", "Barre", "Sans charge"], video: "https://www.youtube.com/watch?v=nbee7NZjZWU"},
                {nom: "Hip Thrust", description: "Dos sur banc, pousser hanches vers haut avec barre.", technique: ["Épaules sur banc", "Pieds largeur hanches", "Extension complète hanches", "Serrer fessiers haut"], variantes: ["Une jambe", "Bande élastique", "Lesté"], video: "https://www.youtube.com/watch?v=Dj3ZIsic-Ng"},
                {nom: "Abducteur Machine", description: "Assis, écarter jambes contre résistance machine (travail fessiers moyen/petit).", technique: ["Dos contre dossier", "Écarter au maximum", "Contracter fessiers", "Retour contrôlé"], variantes: ["Débout câble", "Bande élastique", "Allongé latéral"], video: "https://www.youtube.com/shorts/yaaNq6AY--U"},
                {nom: "Adducteur Machine", description: "Assis, rapprocher jambes contre résistance machine.", technique: ["Dos contre dossier", "Rapprocher jambes complètement", "Contracter adducteurs", "Retour contrôlé"], variantes: ["Débout câble", "Bande élastique", "Copenhagen plank"], video: "https://www.youtube.com/shorts/6zLpLB5vXjU"},
                {nom: "Presse Inclinée", description: "Allongé sur presse, pousser plateforme avec jambes.", technique: ["Pieds largeur épaules", "Genoux alignés pieds", "Descente 90°", "Pousser talons"], variantes: ["Pieds hauts (ischio)", "Pieds bas (quadri)", "Une jambe"], videos: ["https://www.youtube.com/shorts/HjgE-d4cMU0", "https://www.youtube.com/shorts/05XSMArzND8"]},
                {nom: "Leg Curl", description: "Allongé/assis, fléchir jambes ramener poids.", technique: ["Contracter ischio-jambiers", "Amplitude complète", "Pas cambrer", "Contrôler retour"], variantes: ["Allongé", "Assis", "Debout un pied"], video: "https://www.youtube.com/shorts/D1lq3jegNQI"},
                {nom: "Leg Extension", description: "Assis, étendre jambes pousser poids.", technique: ["Dos contre dossier", "Extension complète", "Contracter quadriceps", "Descente contrôlée"], variantes: ["2 jambes", "Une jambe", "Pieds vers intérieur/extérieur"], video: "https://www.youtube.com/shorts/xSBbJnpZ3Js"},
                {nom: "Mollets Debout", description: "Debout, monter sur pointes de pieds.", technique: ["Amplitude maximale", "Pause en haut", "Descente complète", "Pieds parallèles"], variantes: ["Barre", "Machine", "Presse", "Une jambe"], video: "https://www.youtube.com/watch?v=ovIJTRPxlVQ"}
            ],

            exercicesAbdos: [
                {nom: "Circuit Abdos 1 (45s/15s)", description: "Circuit training 45s travail / 15s repos, 2-3 tours.", technique: ["Maintenir forme", "Respiration contrôlée", "Qualité > quantité", "Pause si besoin"], variantes: ["Ajouter lest", "Augmenter tempo", "Réduire repos"], video: "https://www.youtube.com/watch?v=UA-OWzKAk9Y"},
                {nom: "Circuit Abdos 2 (45s/15s)", description: "Circuit training 45s travail / 15s repos, 2-3 tours.", technique: ["Engagement constant", "Contrôle mouvements", "Gainage permanent", "Concentration"], variantes: ["Modifier exercices", "Temps sous tension", "Plus de tours"], video: "https://www.youtube.com/shorts/YiPXMVfsIBM"}
            ]
        };// PARTIE 3/4 - RENDU
        
        class LivretApp {
            constructor() {
                this.currentUser = null;
                this.currentView = securite.estDejaConnecte() ? 'login' : 'code-access';
                this.currentTab = 'dashboard';
                this.sessions = [];
                this.rmHistory = [];
                this.currentSession = null;
                this.userAvatar = null;
                this.musclesList = ['Pectoraux', 'Grand dorsal', 'Trapèzes', 'Deltoïdes', 'Biceps', 'Triceps', 'Abdominaux', 'Quadriceps', 'Ischio-jambiers', 'Fessiers', 'Mollets', 'Adducteurs'];
                this.currentCoursTab = 'principes';
                this.exercicesTemp = [];
                this.musclesTemp = [];
                this.exercicesDetaillesTemp = []; // Nouveau système
                this.timerMode = 'repos';
                this.timerSeconds = 60;
                this.timerRunning = false;
                this.timerInterval = null;
                this.chronoSeconds = 0;
                this.chronoRunning = false;
                this.chronoInterval = null;
                this.chronoLaps = [];
                this.sessionHistory = [];
                this.isOnline = navigator.onLine;
                this.searchQuery = '';
                this.activeFilters = [];
                this.calculatedCharges = {};
                this.selectedPercentage = 75;
                this.currentTheme = 'cyan';
                this.badges = [];
                this.objectifs = [];
                this.currentStreak = 0;
                this.longestStreak = 0;
                this.exercicesDetails = []; // Nouvelle structure pour les exercices détaillés
                this.currentExerciceForm = {}; // Formulaire d'exercice en cours
                this.sessionStep = 1; // Étape actuelle (1=infos, 2=exercices, 3=validation)
                this.sessionNomTemp = ''; // Nom temporaire de la séance
                this.sessionMobileTemp = 'Hypertrophie'; // Mobile temporaire
                this.editingRM = null; // Index du RM en cours d'édition
                this.init();
                this.initOfflineMode();
            }

            init() {
                this.loadSessions();
                this.loadRMHistory();
                this.loadUserAvatar();
                this.loadSessionHistory();
                this.loadCalculatedCharges();
                this.loadTheme();
                this.loadBadges();
                this.loadObjectifs();
                this.calculateStreaks();
                this.checkBadges();
                                this.editingHistoryId = null;
                this.render();
            }

            initOfflineMode() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateOfflineBanner();
                });
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateOfflineBanner();
                });
                this.updateOfflineBanner();
            }

            updateOfflineBanner() {
                const banner = document.getElementById('offline-banner');
                if (!this.isOnline) {
                    banner.innerHTML = '<span class="offline-indicator"></span>Mode hors-ligne - Données sauvegardées localement';
                    banner.classList.remove('hidden');
                } else {
                    banner.classList.add('hidden');
                }
            }

            loadSessions() {
                if (!this.currentUser) return;
                const result = storage.get('sessions');
                if (result.exists) this.sessions = JSON.parse(result.value);
            }

            saveSessions() { storage.save('sessions', this.sessions); }

            loadRMHistory() {
                if (!this.currentUser) return;
                const result = storage.get('rmHistory');
                if (result.exists) this.rmHistory = JSON.parse(result.value);
            }

            saveRMHistory() { storage.save('rmHistory', this.rmHistory); }

            loadUserAvatar() {
                if (!this.currentUser) return;
                const result = storage.get('avatar');
                if (result.exists) this.userAvatar = JSON.parse(result.value);
            }

            saveUserAvatar() { storage.save('avatar', this.userAvatar); }

            loadSessionHistory() {
                if (!this.currentUser) return;
                const result = storage.get('sessionHistory');
                if (result.exists) this.sessionHistory = JSON.parse(result.value);
            }

            saveSessionHistory() { storage.save('sessionHistory', this.sessionHistory); }

            loadCalculatedCharges() {
                if (!this.currentUser) return;
                const result = storage.get('calculatedCharges');
                if (result.exists) this.calculatedCharges = JSON.parse(result.value);
            }

            saveCalculatedCharges() { storage.save('calculatedCharges', this.calculatedCharges); }

            loadUserData() {
                if (!this.currentUser) return;
                this.loadSessions();
                this.loadRMHistory();
                this.loadUserAvatar();
                this.loadSessionHistory();
                this.loadCalculatedCharges();
                this.loadTheme();
                this.loadBadges();
                this.loadObjectifs();
                this.updateStreak();
            }

            updateStreak() {
                if (!this.sessionHistory || this.sessionHistory.length === 0) {
                    this.currentStreak = 0;
                    this.longestStreak = 0;
                    return;
                }

                // Obtenir les dates uniques des séances complétées, triées
                const completedDates = this.sessionHistory
                    .filter(h => h.completed)
                    .map(h => {
                        const date = new Date(h.completedAt);
                        return new Date(date.getFullYear(), date.getMonth(), date.getDate()).getTime();
                    })
                    .filter((value, index, self) => self.indexOf(value) === index)
                    .sort((a, b) => b - a);

                if (completedDates.length === 0) {
                    this.currentStreak = 0;
                    this.longestStreak = 0;
                    return;
                }

                // Calculer la série actuelle
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTime = today.getTime();
                const oneDayMs = 24 * 60 * 60 * 1000;

                this.currentStreak = 0;
                let currentDate = todayTime;

                for (let i = 0; i < completedDates.length; i++) {
                    const dateTime = completedDates[i];
                    const diff = Math.abs(currentDate - dateTime);
                    
                    if (diff === 0) {
                        this.currentStreak++;
                        currentDate -= oneDayMs;
                    } else if (diff === oneDayMs) {
                        this.currentStreak++;
                        currentDate = dateTime - oneDayMs;
                    } else {
                        break;
                    }
                }

                // Calculer la plus longue série de tous les temps
                let maxStreak = 0;
                let tempStreak = 1;

                for (let i = 0; i < completedDates.length - 1; i++) {
                    const diff = completedDates[i] - completedDates[i + 1];
                    if (diff === oneDayMs) {
                        tempStreak++;
                        maxStreak = Math.max(maxStreak, tempStreak);
                    } else {
                        tempStreak = 1;
                    }
                }

                this.longestStreak = Math.max(maxStreak, this.currentStreak);
            }

            loadTheme() {
                if (!this.currentUser) return;
                const result = storage.get('theme');
                if (result.exists) {
                    this.currentTheme = result.value;
                    this.applyTheme(this.currentTheme);
                }
            }

            saveTheme() { storage.save('theme', this.currentTheme); }

            applyTheme(theme) {
                document.body.className = '';
                if (theme !== 'cyan') document.body.classList.add(`theme-${theme}`);
            }



            loadBadges() {
                if (!this.currentUser) return;
                const result = storage.get('badges');
                if (result.exists) {
                    this.badges = JSON.parse(result.value);
                } else {
                    this.badges = this.initializeBadges();
                    this.saveBadges();
                }
            }

            saveBadges() { storage.save('badges', this.badges); }

            initializeBadges() {
                return [
                    {id: 'first-session', name: 'Première Séance', icon: '🎯', description: 'Créer votre première séance', unlocked: false},
                    {id: 'first-rm', name: 'Premier Test', icon: '💪', description: 'Calculer votre premier 1RM', unlocked: false},
                    {id: 'sessions-5', name: 'Débutant', icon: '🔥', description: 'Effectuer 5 séances', unlocked: false},
                    {id: 'sessions-10', name: 'Régulier', icon: '⚡', description: 'Effectuer 10 séances', unlocked: false},
                    {id: 'sessions-25', name: 'Assidu', icon: '💎', description: 'Effectuer 25 séances', unlocked: false},
                    {id: 'sessions-50', name: 'Expert', icon: '👑', description: 'Effectuer 50 séances', unlocked: false},
                    {id: 'rm-5', name: 'Testeur', icon: '🎪', description: 'Effectuer 5 tests 1RM', unlocked: false},
                    {id: 'weekly-streak', name: 'Hebdomadaire', icon: '📅', description: 'Séances 7 jours consécutifs', unlocked: false},
                    {id: 'all-mobiles', name: 'Polyvalent', icon: '🌟', description: 'Tester les 3 mobiles', unlocked: false}
                ];
            }

            checkBadges() {
                const completedCount = this.sessionHistory.filter(h => h.completed).length;
                const rmCount = this.rmHistory.length;
                const hasAllMobiles = this.sessions.some(s => s.type === 'Force') && 
                                     this.sessions.some(s => s.type === 'Équilibre') && 
                                     this.sessions.some(s => s.type === 'Endurance');

                const badgeChecks = [
                    {id: 'first-session', condition: this.sessions.length >= 1},
                    {id: 'first-rm', condition: rmCount >= 1},
                    {id: 'sessions-5', condition: completedCount >= 5},
                    {id: 'sessions-10', condition: completedCount >= 10},
                    {id: 'sessions-25', condition: completedCount >= 25},
                    {id: 'sessions-50', condition: completedCount >= 50},
                    {id: 'rm-5', condition: rmCount >= 5},
                    {id: 'all-mobiles', condition: hasAllMobiles}
                ];

                let newBadgesUnlocked = false;
                badgeChecks.forEach(check => {
                    const badge = this.badges.find(b => b.id === check.id);
                    if (badge && !badge.unlocked && check.condition) {
                        badge.unlocked = true;
                        badge.unlockedAt = new Date().toISOString();
                        newBadgesUnlocked = true;
                    }
                });

                if (newBadgesUnlocked) this.saveBadges();
            }

            render() {
                const app = document.getElementById('app');
                if (this.currentView === 'code-access') {
                    app.innerHTML = this.renderCodeAccess();
                    this.attachCodeAccessEvents();
                } else if (this.currentView === 'login') {
                    app.innerHTML = this.renderLogin();
                    this.attachLoginEvents();
                } else if (this.currentView === 'signup') {
                    app.innerHTML = this.renderSignup();
                    this.attachSignupEvents();
                } else if (this.currentView === 'dashboard') {
                    app.innerHTML = this.renderDashboard();
                    this.attachDashboardEvents();
                } else if (this.currentView === 'session-form') {
                    app.innerHTML = this.renderSessionForm();
                    this.attachSessionFormEvents();
                } else if (this.currentView === 'session-detail') {
                    app.innerHTML = this.renderSessionDetail();
                    this.attachSessionDetailEvents();
                } else if (this.currentView === 'session-live') {
                    app.innerHTML = this.renderSessionLive();
                } else if (this.currentView === 'session-bilan') {
                    app.innerHTML = this.renderSessionBilan();
                }
            }

            renderCodeAccess() {
                return `
                    <div class="container">
                        <div class="card" style="max-width: 500px; margin: 4rem auto;">
                            <div class="text-center mb-4">
                                <div class="user-icon" style="margin: 0 auto 1.5rem;">🔒</div>
                                <h1 class="text-white" style="font-size: 2rem; margin-bottom: 0.5rem;">Accès Protégé</h1>
                                <p class="text-cyan">Entrez le code d'accès de votre classe</p>
                            </div>
                            <div>
                                <div class="mb-4">
                                    <label class="text-white mb-1" style="display: block;">Code de classe</label>
                                    <input 
                                        type="password" 
                                        class="input" 
                                        id="code-input" 
                                        placeholder="Ex: 1CAPECP25" 
                                        autofocus
                                        onkeypress="if(event.key === 'Enter') app.submitCode()"
                                    >
                                </div>
                                <button type="button" class="btn btn-primary" style="width: 100%;" onclick="app.submitCode()">Valider</button>
                            </div>
                            <div id="code-error" class="hidden" style="margin-top: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 0.75rem;">
                                <p class="text-white" style="text-align: center;">❌ Code incorrect</p>
                            </div>
                            <div class="tip-box" style="margin-top: 2rem;">
                                <div class="text-white" style="font-weight: 600; margin-bottom: 0.5rem;">💡 Code oublié ?</div>
                                <p class="text-white" style="opacity: 0.8; font-size: 0.9rem;">Demandez le code à votre professeur.</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderLogin() {
                const users = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('user-') && !key.includes('-sessions') && !key.includes('-rmHistory') && !key.includes('-avatar') && !key.includes('-sessionHistory') && !key.includes('-calculatedCharges') && !key.includes('-theme') && !key.includes('-badges')) {
                        users.push(key.replace('user-', ''));
                    }
                }

                return `
                    <div class="container">
                        <div class="card" style="max-width: 450px; margin: 4rem auto;">
                            <div class="text-center mb-4">
                                <div class="user-icon" style="margin: 0 auto 1.5rem;">💪</div>
                                <h1 class="text-white" style="font-size: 2rem; margin-bottom: 0.5rem;">Livret de Musculation</h1>
                                <p class="text-cyan">Suivi personnalisé - ${securite.getNomClasse()}</p>
                            </div>
                            ${users.length > 0 ? `
                                <div class="mb-4">
                                    <label class="text-white mb-1" style="display: block;">Sélectionner un profil</label>
                                    <select class="input" id="select-user">
                                        <option value="">-- Choisir un profil --</option>
                                        ${users.map(u => `<option value="${u}">${u}</option>`).join('')}
                                    </select>
                                </div>
                                <button class="btn btn-primary" style="width: 100%; margin-bottom: 1rem;" onclick="app.handleSelectUser()">Se connecter</button>
                                <div class="text-center">
                                    <button class="btn btn-link" onclick="app.showSignup()">Créer un nouveau profil</button>
                                </div>
                            ` : `
                                <div class="text-center">
                                    <p class="text-white mb-4" style="opacity: 0.8;">Aucun profil existant</p>
                                    <button class="btn btn-success" style="width: 100%;" onclick="app.showSignup()">Créer mon profil</button>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderSignup() {
                return `
                    <div class="container">
                        <div class="card" style="max-width: 500px; margin: 2rem auto;">
                            <div class="text-center mb-4">
                                <h1 class="text-white" style="font-size: 2rem; margin-bottom: 0.5rem;">Créer mon profil</h1>
                                <p class="text-cyan">Renseignez vos informations - ${securite.getNomClasse()}</p>
                            </div>
                            <div>
                                <div class="text-center mb-4">
                                    <input type="file" id="avatar-input" accept="image/*" style="display: none;">
                                    <div class="avatar-upload" onclick="document.getElementById('avatar-input').click()">
                                        <span id="avatar-preview">📷</span>
                                    </div>
                                    <p class="text-white" style="opacity: 0.7; font-size: 0.9rem;">Cliquez pour ajouter une photo</p>
                                </div>
                                <div class="mb-2">
                                    <label class="text-white mb-1" style="display: block;">Prénom</label>
                                    <input type="text" class="input" id="signup-username" placeholder="Votre prénom">
                                </div>
                                <div class="grid grid-cols-2 gap-3 mb-2">
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Âge</label>
                                        <input type="number" class="input" id="signup-age" placeholder="Ex: 25" min="10" max="100">
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Sexe</label>
                                        <select class="input" id="signup-sexe">
                                            <option value="">Choisir...</option>
                                            <option value="Homme">Homme</option>
                                            <option value="Femme">Femme</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 mb-4">
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Taille (cm)</label>
                                        <input type="number" class="input" id="signup-taille" placeholder="Ex: 175" min="100" max="250">
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Poids (kg)</label>
                                        <input type="number" class="input" id="signup-poids" placeholder="Ex: 70" min="30" max="200" step="0.1">
                                    </div>
                                </div>
                                <button type="button" class="btn btn-success" style="width: 100%; margin-bottom: 1rem;" onclick="app.submitSignup()">Créer mon profil</button>
                                <div class="text-center">
                                    <button type="button" class="btn btn-link" onclick="app.showLogin()">Retour</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderDashboard() {
                const userKey = `user-${this.currentUser}`;
                const userResult = storage.get(userKey, true);
                const userData = userResult.exists ? JSON.parse(userResult.value) : {};
                const completedSessions = this.sessionHistory.filter(h => h.completed).length;
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                const sessionsThisMonth = this.sessionHistory.filter(h => {
                    const date = new Date(h.completedAt);
                    return h.completed && date.getMonth() === thisMonth && date.getFullYear() === thisYear;
                }).length;
                const unlockedBadges = this.badges.filter(b => b.unlocked).length;

                return `
                    <div class="container">
                        <div class="card">
                        ${IS_COACH_MODE ? `
                            <div class="coach-mode-banner">
                                🎓 MODE COACH ACTIVÉ - Historique éditable
                            </div>
                        ` : ''}
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center gap-3">
                                    ${this.userAvatar ? `<img src="${this.userAvatar}" class="profile-avatar" alt="Avatar">` : `<div class="default-avatar">👤</div>`}
                                    <div>
                                        <h1 class="text-white" style="font-size: 2rem;">${this.currentUser}</h1>
                                        <p class="text-cyan" style="font-size: 0.9rem;">${userData.age} ans • ${userData.sexe} • ${userData.taille}cm • ${userData.poids}kg</p>
                                        <p class="text-white" style="opacity: 0.7; font-size: 0.85rem; margin-top: 0.25rem;">📚 ${securite.getNomClasse()} • 🏆 ${unlockedBadges}/${this.badges.length} badges</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-warning" onclick="app.exportData()">💾</button>
                                    <button class="btn btn-warning" onclick="app.importData()">📥</button>
                                    <button class="btn btn-danger" onclick="app.logout()" style="font-weight: 600;">🚪 Changer de profil</button>
                                </div>
                            </div>
                            <div class="flex gap-2 mb-4" style="overflow-x: auto;">
                                <button class="tab-btn ${this.currentTab === 'dashboard' ? 'active' : ''}" onclick="app.switchTab('dashboard')">📊 Dashboard</button>
                                <button class="tab-btn ${this.currentTab === 'profil' ? 'active' : ''}" onclick="app.switchTab('profil')">👤 Profil</button>
                                <button class="tab-btn ${this.currentTab === 'rm' ? 'active' : ''}" onclick="app.switchTab('rm')">🎯 1RM</button>
                                <button class="tab-btn ${this.currentTab === 'charges' ? 'active' : ''}" onclick="app.switchTab('charges')">⚖️ Charges</button>
                                <button class="tab-btn ${this.currentTab === 'progression' ? 'active' : ''}" onclick="app.switchTab('progression')">📊 Graphiques</button>
                                <button class="tab-btn ${this.currentTab === 'sessions' ? 'active' : ''}" onclick="app.switchTab('sessions')">📝 Séances</button>
                                <button class="tab-btn ${this.currentTab === 'historique' ? 'active' : ''}" onclick="app.switchTab('historique')">📅 Historique</button>
                                <button class="tab-btn ${this.currentTab === 'badges' ? 'active' : ''}" onclick="app.switchTab('badges')">🏆 Badges</button>
                                <button class="tab-btn ${this.currentTab === 'objectifs' ? 'active' : ''}" onclick="app.switchTab('objectifs')">🎯 Objectifs</button>
                                <button class="tab-btn ${this.currentTab === 'cours' ? 'active' : ''}" onclick="app.switchTab('cours')">📚 Cours</button>
                            </div>
                            ${this.currentTab === 'dashboard' ? this.renderDashboardTab(completedSessions, sessionsThisMonth) : ''}
                            ${this.currentTab === 'profil' ? this.renderProfilTab() : ''}
                            ${this.currentTab === 'rm' ? this.renderRMTab() : ''}
                            ${this.currentTab === 'charges' ? this.renderChargesTab() : ''}
                            ${this.currentTab === 'progression' ? this.renderProgressionTab() : ''}
                            ${this.currentTab === 'sessions' ? this.renderSessionsTab() : ''}
                            ${this.currentTab === 'timer' ? this.renderTimerTab() : ''}
                            ${this.currentTab === 'historique' ? this.renderHistoriqueTab() : ''}
                            ${this.currentTab === 'badges' ? this.renderBadgesTab() : ''}
                            ${this.currentTab === 'objectifs' ? this.renderObjectifsTab() : ''}
                            ${this.currentTab === 'cours' ? this.renderCoursTab() : ''}
                        </div>
                    </div>
                `;
            }

            renderDashboardTab(completedSessions, sessionsThisMonth) {
                const stats = {
                    total: this.sessions.length,
                    force: this.sessions.filter(s => s.type === 'Force').length,
                    endurance: this.sessions.filter(s => s.type === 'Endurance').length,
                    equilibre: this.sessions.filter(s => s.type === 'Équilibre').length
                };
                const unlockedBadges = this.badges.filter(b => b.unlocked).length;
                const recentBadges = this.badges.filter(b => b.unlocked).sort((a, b) => new Date(b.unlockedAt) - new Date(a.unlockedAt)).slice(0, 3);

                return `
                    <div class="grid grid-cols-2 gap-3 mb-4">
                        <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(6, 182, 212, 0.3);">
                            <div class="text-cyan" style="font-size: 2.5rem; font-weight: bold;">${stats.total}</div>
                            <div class="text-white" style="opacity: 0.9;">Séances créées</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(20, 184, 166, 0.2) 100%); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(16, 185, 129, 0.3);">
                            <div style="color: #10b981; font-size: 2.5rem; font-weight: bold;">${completedSessions}</div>
                            <div class="text-white" style="opacity: 0.9;">Séances effectuées</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(249, 115, 22, 0.2) 0%, rgba(251, 146, 60, 0.2) 100%); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(249, 115, 22, 0.3);">
                            <div style="color: #fb923c; font-size: 2.5rem; font-weight: bold;">${sessionsThisMonth}</div>
                            <div class="text-white" style="opacity: 0.9;">Ce mois-ci</div>
                        </div>
                        <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(147, 51, 234, 0.2) 100%); border-radius: 1rem; padding: 1.5rem; border: 1px solid rgba(168, 85, 247, 0.3);">
                            <div style="color: #a855f7; font-size: 2.5rem; font-weight: bold;">${unlockedBadges}</div>
                            <div class="text-white" style="opacity: 0.9;">Badges</div>
                        </div>
                    </div>
                    ${this.currentStreak > 0 ? `
                        <div class="tip-box" style="border-color: #fb923c; background: linear-gradient(135deg, rgba(251, 146, 60, 0.2) 0%, rgba(249, 115, 22, 0.1) 100%);">
                            <div class="flex justify-between items-center">
                                <div>
                                    <div class="text-white" style="font-weight: 600; margin-bottom: 0.5rem;">🔥 Série en cours</div>
                                    <div class="text-white" style="opacity: 0.9;">${this.currentStreak} jour${this.currentStreak > 1 ? "s" : ""} consécutif${this.currentStreak > 1 ? "s" : ""} !</div>
                                </div>
                                <div style="color: #fb923c; font-size: 3rem; font-weight: bold;">${this.currentStreak}</div>
                            </div>
                        </div>
                    ` : ""}
                    ${recentBadges.length > 0 ? `
                        <div class="tip-box" style="border-color: #a855f7; background: rgba(168, 85, 247, 0.1);">
                            <div class="text-white" style="font-weight: 600; margin-bottom: 0.75rem;">🏆 Derniers badges</div>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                ${recentBadges.map(b => `<div style="display: flex; align-items: center; gap: 0.5rem;"><span style="font-size: 2rem;">${b.icon}</span><div><div class="text-white" style="font-weight: 600;">${b.name}</div></div></div>`).join('')}
                            </div>
                        </div>
                    ` : ''}
                    <div class="tip-box">
                        <div class="text-white" style="font-weight: 600; margin-bottom: 0.5rem;">💡 Conseil du jour</div>
                        <div class="text-white" style="opacity: 0.9;">Échauffez-vous bien et étirez-vous après. La récupération est aussi importante que l'entraînement !</div>
                    </div>
                `;
            }renderProfilTab() {
                const userKey = `user-${this.currentUser}`;
                const userResult = storage.get(userKey, true);
                const userData = userResult.exists ? JSON.parse(userResult.value) : {};

                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">🎨 Thème de couleur</h2>
                        <div class="theme-selector mb-4">
                            <button class="theme-btn theme-cyan ${this.currentTheme === 'cyan' ? 'active' : ''}" onclick="app.changeTheme('cyan')" title="Cyan"></button>
                            <button class="theme-btn theme-blue ${this.currentTheme === 'blue' ? 'active' : ''}" onclick="app.changeTheme('blue')" title="Bleu"></button>
                            <button class="theme-btn theme-green ${this.currentTheme === 'green' ? 'active' : ''}" onclick="app.changeTheme('green')" title="Vert"></button>
                            <button class="theme-btn theme-purple ${this.currentTheme === 'purple' ? 'active' : ''}" onclick="app.changeTheme('purple')" title="Violet"></button>
                            <button class="theme-btn theme-orange ${this.currentTheme === 'orange' ? 'active' : ''}" onclick="app.changeTheme('orange')" title="Orange"></button>
                        </div>

                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">👤 Mes informations</h2>
                        <form id="profile-form">
                            <div class="text-center mb-4">
                                <input type="file" id="profile-avatar-input" accept="image/*" style="display: none;">
                                <div style="cursor: pointer; display: inline-block;" onclick="document.getElementById('profile-avatar-input').click()">
                                    ${this.userAvatar ? `<img src="${this.userAvatar}" class="profile-avatar" alt="Avatar">` : `<div class="default-avatar">👤</div>`}
                                </div>
                                <p class="text-white" style="opacity: 0.7; font-size: 0.9rem; margin-top: 0.5rem;">Cliquez pour changer la photo</p>
                            </div>
                            <div class="mb-2">
                                <label class="text-white mb-1" style="display: block;">Prénom</label>
                                <input type="text" class="input" value="${this.currentUser}" disabled>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-2">
                                <div>
                                    <label class="text-white mb-1" style="display: block;">Âge</label>
                                    <input type="number" class="input" id="profile-age" value="${userData.age}" min="10" max="100" required>
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block;">Sexe</label>
                                    <select class="input" id="profile-sexe" required>
                                        <option value="Homme" ${userData.sexe === 'Homme' ? 'selected' : ''}>Homme</option>
                                        <option value="Femme" ${userData.sexe === 'Femme' ? 'selected' : ''}>Femme</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <div>
                                    <label class="text-white mb-1" style="display: block;">Taille (cm)</label>
                                    <input type="number" class="input" id="profile-taille" value="${userData.taille}" min="100" max="250" required>
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block;">Poids (kg)</label>
                                    <input type="number" class="input" id="profile-poids" value="${userData.poids}" min="30" max="200" step="0.1" required>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-success" style="width: 100%;">💾 Enregistrer</button>
                        </form>
                    </div>
                `;
            }

            renderRMTab() {
                // Trier l'historique : muscle > exercice > date (plus récent en premier)
                const sortedHistory = [...this.rmHistory].sort((a, b) => {
                    // 1. Tri par muscle
                    if (a.muscle !== b.muscle) {
                        return a.muscle.localeCompare(b.muscle);
                    }
                    // 2. Tri par exercice
                    if (a.exercise !== b.exercise) {
                        return a.exercise.localeCompare(b.exercise);
                    }
                    // 3. Tri par date (plus récent en premier)
                    return new Date(b.date) - new Date(a.date);
                });
                
                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">🎯 Calculateur de 1RM</h2>
                        
                        ${this.editingRM !== null ? `
                            <!-- Formulaire d'édition -->
                            <div style="background: rgba(251, 191, 36, 0.1); padding: 1.5rem; border-radius: 1rem; border: 2px solid #fbbf24; margin-bottom: 2rem;">
                                <h3 class="text-white mb-3" style="font-size: 1.2rem;">✏️ Modifier le test</h3>
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Groupe musculaire</label>
                                        <select class="input" id="edit-rm-muscle">
                                            ${this.musclesList.map(m => `<option value="${m}" ${sortedHistory[this.editingRM].muscle === m ? 'selected' : ''}>${m}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Exercice</label>
                                        <input type="text" class="input" id="edit-rm-exercise" value="${sortedHistory[this.editingRM].exercise}">
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3 mb-3">
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Charge (kg)</label>
                                        <input type="number" class="input" id="edit-rm-weight" value="${sortedHistory[this.editingRM].weight}" step="0.5">
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Répétitions</label>
                                        <input type="number" class="input" id="edit-rm-reps" value="${sortedHistory[this.editingRM].reps}" min="1" max="20">
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Date</label>
                                        <input type="date" class="input" id="edit-rm-date" value="${sortedHistory[this.editingRM].date.split('T')[0]}">
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="btn btn-success" onclick="app.saveEditRM()" style="flex: 1;">💾 Enregistrer</button>
                                    <button class="btn btn-secondary" onclick="app.cancelEditRM()" style="flex: 1;">❌ Annuler</button>
                                </div>
                            </div>
                        ` : `
                            <!-- Formulaire de création -->
                            <form id="rm-form" class="mb-4">
                                <div class="grid grid-cols-2 gap-3 mb-3">
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Groupe musculaire</label>
                                        <select class="input" id="rm-muscle" required>
                                            <option value="">Sélectionner...</option>
                                            ${this.musclesList.map(m => `<option value="${m}">${m}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Exercice</label>
                                        <input type="text" class="input" id="rm-exercise" placeholder="Ex: Développé couché" required>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-3 mb-3">
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Charge (kg)</label>
                                        <input type="number" class="input" id="rm-weight" placeholder="Ex: 80" min="1" step="0.5" required>
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Répétitions</label>
                                        <input type="number" class="input" id="rm-reps" placeholder="Ex: 8" min="1" max="20" required>
                                    </div>
                                    <div>
                                        <label class="text-white mb-1" style="display: block;">Date</label>
                                        <input type="date" class="input" id="rm-date" required>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary" style="width: 100%;">Calculer mon 1RM</button>
                            </form>
                        `}
                        
                        <div id="rm-result" class="hidden mb-4"></div>
                        
                        ${sortedHistory.length > 0 ? `
                            <h3 class="text-white mb-3" style="font-size: 1.2rem;">📊 Historique (${sortedHistory.length})</h3>
                            ${(() => {
                                // Grouper par muscle
                                const byMuscle = {};
                                sortedHistory.forEach((test, index) => {
                                    if (!byMuscle[test.muscle]) {
                                        byMuscle[test.muscle] = [];
                                    }
                                    byMuscle[test.muscle].push({ test, index });
                                });
                                
                                // Afficher chaque groupe
                                return Object.entries(byMuscle).map(([muscle, tests]) => `
                                    <div style="background: rgba(6, 182, 212, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid var(--primary-color);">
                                        <h4 class="text-cyan mb-3" style="font-size: 1.2rem; font-weight: 600;">💪 ${muscle} (${tests.length})</h4>
                                        ${tests.map(({ test, index }) => `
                                            <div class="rm-history-card" style="margin-bottom: 1rem; background: rgba(15, 23, 42, 0.6);">
                                                <div class="flex justify-between items-center">
                                                    <div>
                                                        <div class="text-cyan" style="font-weight: 600; font-size: 1.1rem;">${test.exercise}</div>
                                                        <div class="text-white" style="opacity: 0.7; font-size: 0.9rem; margin-top: 0.5rem;">${test.weight}kg × ${test.reps} rép. • ${new Date(test.date).toLocaleDateString('fr-FR')}</div>
                                                    </div>
                                                    <div>
                                                        <div style="color: #10b981; font-size: 2rem; font-weight: bold; text-align: center;">${test.rm}kg</div>
                                                        <div class="text-white" style="opacity: 0.7; font-size: 0.85rem; text-align: center;">1RM</div>
                                                        <div class="flex gap-2 mt-2">
                                                            <button class="btn btn-warning" style="padding: 0.5rem 1rem;" onclick="app.editRM(${index})">✏️</button>
                                                            <button class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="app.deleteRM(${index})">🗑️</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                `).join('');
                            })()}
                        ` : `
                            <div class="text-center" style="padding: 3rem 1rem; opacity: 0.5;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">📊</div>
                                <div class="text-white">Aucun test effectué</div>
                            </div>
                        `}
                    </div>
                `;
            }

            renderChargesTab() {
                const selectedPercentage = this.selectedPercentage || 75; // Défaut 75%
                
                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">⚖️ Calculateur de charges</h2>
                        <div class="charges-calculator mb-4">
                            <div class="mb-3">
                                <label class="text-white mb-1" style="display: block; font-weight: 600;">Sélectionner un test 1RM</label>
                                <select class="input" id="charges-rm-select" onchange="app.calculateCharges()">
                                    <option value="">-- Choisir un test --</option>
                                    ${this.rmHistory.map((test, index) => `<option value="${index}" ${this.calculatedCharges.selectedIndex === index ? 'selected' : ''}>${test.exercise} - ${test.rm}kg (${new Date(test.date).toLocaleDateString('fr-FR')})</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div id="charges-result">
                            ${this.calculatedCharges.rm ? `
                                <div class="mb-4">
                                    <div class="text-center mb-4">
                                        <div class="text-cyan" style="font-size: 1.3rem; font-weight: 600;">${this.calculatedCharges.exercise}</div>
                                        <div class="text-white" style="opacity: 0.8;">1RM: ${this.calculatedCharges.rm}kg</div>
                                    </div>
                                    
                                    <!-- Curseur de pourcentage -->
                                    <div style="background: rgba(15, 23, 42, 0.8); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid var(--primary-color);">
                                        <div class="text-center mb-3">
                                            <div class="text-white mb-2" style="font-size: 1.1rem; font-weight: 600;">🎚️ Ajuster le pourcentage</div>
                                            <div class="text-cyan" style="font-size: 2.5rem; font-weight: bold;">${selectedPercentage}%</div>
                                            <div class="text-white mt-2" style="font-size: 1.8rem; font-weight: 600; color: var(--accent-color);">
                                                ${Math.round(this.calculatedCharges.rm * selectedPercentage / 100)} kg
                                            </div>
                                        </div>
                                        <input 
                                            type="range" 
                                            min="10" 
                                            max="120" 
                                            value="${selectedPercentage}" 
                                            class="input" 
                                            id="percentage-slider"
                                            oninput="app.updatePercentage(this.value)"
                                            style="width: 100%; height: 40px; cursor: pointer; accent-color: var(--primary-color);"
                                        >
                                        <div class="flex justify-between text-white" style="opacity: 0.7; font-size: 0.9rem; margin-top: 0.5rem;">
                                            <span>10%</span>
                                            <span>50%</span>
                                            <span>75%</span>
                                            <span>100%</span>
                                            <span>120%</span>
                                        </div>
                                    </div>
                                    
                                    <!-- Tableau des mobiles -->
                                    <h3 class="text-white mb-3" style="font-size: 1.2rem;">📊 Zones d'entraînement par mobile</h3>
                                    <table class="charges-table">
                                        <thead>
                                            <tr>
                                                <th>Mobile</th>
                                                <th>Zone %</th>
                                                <th>Fourchette de charge</th>
                                                <th>Reps</th>
                                                <th>Repos</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="background: ${selectedPercentage >= 85 && selectedPercentage <= 100 ? 'rgba(239, 68, 68, 0.2)' : 'transparent'};">
                                                <td style="color: #ef4444; font-weight: 600;">💪 Force Max</td>
                                                <td>85-100%</td>
                                                <td class="charge-value">${Math.round(this.calculatedCharges.rm * 0.85)}-${this.calculatedCharges.rm}kg</td>
                                                <td>1-5 rép.</td>
                                                <td>3-5 min</td>
                                            </tr>
                                            <tr style="background: ${selectedPercentage >= 30 && selectedPercentage <= 60 ? 'rgba(247, 147, 22, 0.2)' : 'transparent'};">
                                                <td style="color: #f97316; font-weight: 600;">⚡ Force Explosive</td>
                                                <td>30-60%</td>
                                                <td class="charge-value">${Math.round(this.calculatedCharges.rm * 0.30)}-${Math.round(this.calculatedCharges.rm * 0.60)}kg</td>
                                                <td>3-6 rép.</td>
                                                <td>2-4 min</td>
                                            </tr>
                                            <tr style="background: ${selectedPercentage >= 65 && selectedPercentage <= 80 ? 'rgba(59, 130, 246, 0.2)' : 'transparent'};">
                                                <td style="color: #3b82f6; font-weight: 600;">🏋️ Hypertrophie</td>
                                                <td>65-80%</td>
                                                <td class="charge-value">${Math.round(this.calculatedCharges.rm * 0.65)}-${Math.round(this.calculatedCharges.rm * 0.80)}kg</td>
                                                <td>6-12 rép.</td>
                                                <td>60-90 sec</td>
                                            </tr>
                                            <tr style="background: ${selectedPercentage >= 60 && selectedPercentage <= 75 ? 'rgba(168, 85, 247, 0.2)' : 'transparent'};">
                                                <td style="color: #a855f7; font-weight: 600;">🔥 Endurance Force</td>
                                                <td>60-75%</td>
                                                <td class="charge-value">${Math.round(this.calculatedCharges.rm * 0.60)}-${Math.round(this.calculatedCharges.rm * 0.75)}kg</td>
                                                <td>12-20 rép.</td>
                                                <td>60-90 sec</td>
                                            </tr>
                                            <tr style="background: ${selectedPercentage >= 40 && selectedPercentage <= 60 ? 'rgba(16, 185, 129, 0.2)' : 'transparent'};">
                                                <td style="color: #10b981; font-weight: 600;">🏃 Endurance Muscu</td>
                                                <td>40-60%</td>
                                                <td class="charge-value">${Math.round(this.calculatedCharges.rm * 0.40)}-${Math.round(this.calculatedCharges.rm * 0.60)}kg</td>
                                                <td>20-30+ rép.</td>
                                                <td>30-60 sec</td>
                                            </tr>
                                            <tr style="background: ${selectedPercentage >= 10 && selectedPercentage <= 120 ? 'rgba(168, 85, 247, 0.1)' : 'transparent'};">
                                                <td style="color: #a855f7; font-weight: 600;">⚙️ Personnalisé</td>
                                                <td>10-120%</td>
                                                <td class="charge-value">${Math.round(this.calculatedCharges.rm * 0.10)}-${Math.round(this.calculatedCharges.rm * 1.20)}kg</td>
                                                <td>Variable</td>
                                                <td>Variable</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                    
                                    <!-- Tableau récapitulatif % -->
                                    <h3 class="text-white mb-3 mt-4" style="font-size: 1.2rem;">📋 Tableau récapitulatif des charges</h3>
                                    <div style="overflow-x: auto;">
                                        <table class="charges-table" style="font-size: 0.9rem;">
                                            <thead>
                                                <tr>
                                                    <th>%</th>
                                                    <th>Charge</th>
                                                    <th>%</th>
                                                    <th>Charge</th>
                                                    <th>%</th>
                                                    <th>Charge</th>
                                                    <th>%</th>
                                                    <th>Charge</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(() => {
                                                    let rows = '';
                                                    for (let i = 50; i <= 120; i += 5) {
                                                        if ((i - 50) % 20 === 0) {
                                                            rows += '<tr>';
                                                        }
                                                        const charge = Math.round(this.calculatedCharges.rm * i / 100 * 2) / 2; // Arrondi à 0.5kg
                                                        const isSelected = Math.abs(selectedPercentage - i) <= 2;
                                                        rows += `
                                                            <td style="${isSelected ? 'background: var(--primary-color); color: #0f172a; font-weight: 700;' : ''}">${i}%</td>
                                                            <td style="${isSelected ? 'background: var(--primary-color); color: #0f172a; font-weight: 700;' : ''}" class="charge-value">${charge}kg</td>
                                                        `;
                                                        if ((i - 50) % 20 === 15) {
                                                            rows += '</tr>';
                                                        }
                                                    }
                                                    return rows;
                                                })()}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="text-white mt-3" style="opacity: 0.7; font-size: 0.9rem; text-align: center; background: rgba(6, 182, 212, 0.1); padding: 1rem; border-radius: 0.75rem;">
                                        💡 <strong>Astuce :</strong> Le curseur te permet de trouver la charge exacte pour n'importe quel pourcentage entre 10% et 120% de ton 1RM
                                    </div>
                                </div>
                            ` : `
                                <div class="text-center" style="padding: 3rem 1rem; opacity: 0.5;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">⚖️</div>
                                    <div class="text-white">Sélectionnez un test 1RM ci-dessus</div>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }

            renderProgressionTab() {
                if (this.rmHistory.length === 0) {
                    return `
                        <div>
                            <h2 class="text-white mb-4" style="font-size: 1.5rem;">📊 Graphiques de progression</h2>
                            <div class="text-center" style="padding: 3rem 1rem; opacity: 0.5;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">📈</div>
                                <div class="text-white">Aucune donnée à afficher</div>
                                <div class="text-white" style="opacity: 0.7; font-size: 0.9rem; margin-top: 0.5rem;">Calculez vos premiers 1RM pour voir vos graphiques !</div>
                            </div>
                        </div>
                    `;
                }

                const exerciseGroups = {};
                this.rmHistory.forEach(test => {
                    if (!exerciseGroups[test.exercise]) {
                        exerciseGroups[test.exercise] = [];
                    }
                    exerciseGroups[test.exercise].push(test);
                });

                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">📊 Évolution de vos 1RM</h2>
                        ${Object.entries(exerciseGroups).map(([exercise, tests]) => {
                            const chartId = `chart-${exercise.replace(/\s+/g, '-').toLowerCase()}`;
                            return `
                                <div class="chart-container">
                                    <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">${exercise}</h3>
                                    <canvas id="${chartId}"></canvas>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            renderSessionsTab() {
                return `
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-white" style="font-size: 1.5rem;">📝 Mes séances (${this.sessions.length})</h2>
                            <button class="btn btn-success" onclick="app.createNewSession()">➕ Nouvelle séance</button>
                        </div>
                        ${this.sessions.length > 0 ? `
                            <div class="grid grid-cols-2 gap-3">
                                ${this.sessions.map((session, index) => {
                                    const isCompleted = this.sessionHistory.some(h => h.sessionIndex === index && h.completed);
                                    
                                    // Gérer ancienne et nouvelle structure
                                    const exercices = session.exercicesDetailles || session.exercices || [];
                                    const nbExercices = exercices.length;
                                    const muscles = session.exercicesDetailles 
                                        ? [...new Set(session.exercicesDetailles.map(e => e.muscle))]
                                        : (session.muscles || []);
                                    
                                    return `
                                        <div class="session-card ${isCompleted ? 'completed' : ''}" onclick="app.viewSession(${index})">
                                            ${isCompleted ? '<div class="session-completed-badge">✓ Effectuée</div>' : ''}
                                            <h3 class="text-white mb-2" style="font-size: 1.2rem;">${session.nom}</h3>
                                            <div class="mb-2"><span class="badge badge-${session.type.toLowerCase().replace(/ /g, '-')}">${session.type}</span></div>
                                            <div class="text-white" style="opacity: 0.8; font-size: 0.9rem;">💪 ${muscles.join(', ')}</div>
                                            <div class="text-white" style="opacity: 0.7; font-size: 0.85rem; margin-top: 0.5rem;">📋 ${nbExercices} exercice${nbExercices > 1 ? 's' : ''}</div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center" style="padding: 3rem 1rem; opacity: 0.5;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">📝</div>
                                <div class="text-white">Aucune séance créée</div>
                                <div class="text-white" style="opacity: 0.7; font-size: 0.9rem; margin-top: 0.5rem;">Créez votre première séance !</div>
                            </div>
                        `}
                    </div>
                `;
            }

            renderTimerTab() {
                return `
                    <div>
                        <div class="flex gap-2 mb-4" style="justify-content: center;">
                            <button class="sub-tab-btn ${this.timerMode === 'repos' ? 'active' : ''}" onclick="app.setTimerMode('repos')">⏱️ Timer Repos</button>
                            <button class="sub-tab-btn ${this.timerMode === 'chrono' ? 'active' : ''}" onclick="app.setTimerMode('chrono')">⏲️ Chronomètre</button>
                        </div>
                        ${this.timerMode === 'repos' ? `
                            <div class="timer-container">
                                <h2 class="text-white mb-3" style="font-size: 1.5rem;">⏱️ Timer de Repos</h2>
                                <div class="timer-display ${this.timerRunning ? 'running' : ''} ${this.timerSeconds === 0 ? 'finished' : ''}" id="timer-display">
                                    ${Math.floor(this.timerSeconds / 60).toString().padStart(2, '0')}:${(this.timerSeconds % 60).toString().padStart(2, '0')}
                                </div>
                                <div class="timer-controls">
                                    <button class="timer-preset ${this.timerSeconds === 30 && !this.timerRunning ? 'active' : ''}" onclick="app.setTimerPreset(30)">30s</button>
                                    <button class="timer-preset ${this.timerSeconds === 60 && !this.timerRunning ? 'active' : ''}" onclick="app.setTimerPreset(60)">1min</button>
                                    <button class="timer-preset ${this.timerSeconds === 90 && !this.timerRunning ? 'active' : ''}" onclick="app.setTimerPreset(90)">1min30</button>
                                    <button class="timer-preset ${this.timerSeconds === 120 && !this.timerRunning ? 'active' : ''}" onclick="app.setTimerPreset(120)">2min</button>
                                    <button class="timer-preset ${this.timerSeconds === 180 && !this.timerRunning ? 'active' : ''}" onclick="app.setTimerPreset(180)">3min</button>
                                </div>
                                <div class="timer-input-group">
                                    <input type="number" class="timer-input" id="custom-minutes" placeholder="Min" min="0" max="59">
                                    <span class="text-white">:</span>
                                    <input type="number" class="timer-input" id="custom-seconds" placeholder="Sec" min="0" max="59">
                                    <button class="btn btn-primary" onclick="app.setCustomTimer()">OK</button>
                                </div>
                                <div class="flex gap-3" style="justify-content: center; margin-top: 2rem;">
                                    <button class="btn ${this.timerRunning ? 'btn-warning' : 'btn-success'}" style="min-width: 120px;" onclick="app.toggleTimer()">
                                        ${this.timerRunning ? '⏸️ Pause' : '▶️ Démarrer'}
                                    </button>
                                    <button class="btn btn-secondary" onclick="app.resetTimer()">🔄 Reset</button>
                                </div>
                            </div>
                        ` : `
                            <div class="timer-container">
                                <h2 class="text-white mb-3" style="font-size: 1.5rem;">⏲️ Chronomètre</h2>
                                <div class="timer-display ${this.chronoRunning ? 'running' : ''}" id="chrono-display">
                                    ${Math.floor(this.chronoSeconds / 60).toString().padStart(2, '0')}:${(this.chronoSeconds % 60).toString().padStart(2, '0')}
                                </div>
                                <div class="flex gap-3" style="justify-content: center; margin-top: 2rem;">
                                    <button class="btn ${this.chronoRunning ? 'btn-warning' : 'btn-success'}" style="min-width: 120px;" onclick="app.toggleChrono()">
                                        ${this.chronoRunning ? '⏸️ Pause' : '▶️ Démarrer'}
                                    </button>
                                    ${this.chronoRunning ? `<button class="btn btn-primary" onclick="app.addLap()">📍 Tour</button>` : ''}
                                    <button class="btn btn-secondary" onclick="app.resetChrono()">🔄 Reset</button>
                                </div>
                                ${this.chronoLaps.length > 0 ? `
                                    <div class="chrono-laps">
                                        <h3 class="text-white mb-2" style="font-size: 1.1rem;">📍 Tours (${this.chronoLaps.length})</h3>
                                        ${this.chronoLaps.map((lap, index) => `
                                            <div class="lap-item">
                                                <span>Tour ${index + 1}</span>
                                                <span style="font-weight: 600;">${lap}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `}
                    </div>
                `;
            }

            renderHistoriqueTab() {
                const completedHistory = this.sessionHistory.filter(h => h.completed);
                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">📅 Historique des séances (${completedHistory.length})</h2>
                        ${IS_COACH_MODE ? `
                            <div class="text-white mb-3" style="opacity: 0.8; background: rgba(245, 158, 11, 0.1); padding: 1rem; border-radius: 0.75rem; border-left: 4px solid #f59e0b;">
                                <strong>🎓 Mode Coach :</strong> Vous pouvez éditer et supprimer les entrées de l'historique
                            </div>
                        ` : ''}
                        ${completedHistory.length > 0 ? `
                            ${completedHistory.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt)).map(entry => {
                                const session = this.sessions[entry.sessionIndex];
                                
                                // Si on est en mode édition pour cette entrée
                                if (this.editingHistoryId === entry.id) {
                                    return this.renderHistoryEditForm(entry, session);
                                }
                                
                                // Affichage normal
                                const sessionName = session ? session.nom : (entry.sessionName || 'Séance');
                                const sessionType = session ? session.type : (entry.type || 'Force');
                                
                                return `
                                    <div class="session-history-item">
                                        <div class="flex justify-between items-center mb-2">
                                            <div style="flex: 1;">
                                                <div class="text-cyan" style="font-weight: 600; font-size: 1.1rem;">${sessionName}</div>
                                                <div class="text-white" style="opacity: 0.7; font-size: 0.85rem;">${new Date(entry.completedAt).toLocaleDateString('fr-FR', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'})}</div>
                                            </div>
                                            <div class="flex gap-2 items-center">
                                                <span class="badge badge-${sessionType.toLowerCase()}">${sessionType}</span>
                                                ${IS_COACH_MODE ? `
                                                    <button class="edit-btn" onclick="app.editHistory('${entry.id}')">✏️</button>
                                                    <button class="delete-btn" onclick="app.deleteHistory('${entry.id}')">🗑️</button>
                                                ` : ''}
                                            </div>
                                        </div>
                                        ${entry.notes ? `<div class="text-white" style="opacity: 0.8; font-size: 0.9rem; margin-top: 0.5rem;">💬 ${entry.notes}</div>` : ''}
                                    </div>
                                `;
                            }).join('')}
                        ` : `
                            <div class="text-center" style="padding: 3rem 1rem; opacity: 0.5;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">📅</div>
                                <div class="text-white">Aucune séance effectuée</div>
                            </div>
                        `}
                        ${IS_COACH_MODE ? `
                            <button class="btn btn-primary mt-4" onclick="app.addDemoHistory()" style="width: 100%;">
                                ➕ Ajouter une séance de démonstration
                            </button>
                        ` : ''}
                    </div>
                `;
            }

            renderHistoryEditForm(entry, session) {
                const sessionName = session ? session.nom : (entry.sessionName || '');
                const sessionType = session ? session.type : (entry.type || 'Force');
                
                return `
                    <div class="session-history-item">
                        <div class="edit-form">
                            <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">✏️ Édition de la séance</h3>
                            <div class="mb-3">
                                <label class="text-white mb-2" style="display: block;">Nom de la séance</label>
                                <input type="text" id="edit-name" class="input" value="${sessionName}" placeholder="Nom de la séance">
                            </div>
                            <div class="mb-3">
                                <label class="text-white mb-2" style="display: block;">Type</label>
                                <select id="edit-type" class="input">
                                    <option value="Force" ${sessionType === 'Force' ? 'selected' : ''}>Force</option>
                                    <option value="Équilibre" ${sessionType === 'Équilibre' ? 'selected' : ''}>Équilibre</option>
                                    <option value="Endurance" ${sessionType === 'Endurance' ? 'selected' : ''}>Endurance</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="text-white mb-2" style="display: block;">Date</label>
                                <input type="datetime-local" id="edit-date" class="input" value="${new Date(entry.completedAt).toISOString().slice(0, 16)}">
                            </div>
                            <div class="mb-4">
                                <label class="text-white mb-2" style="display: block;">Notes</label>
                                <textarea id="edit-notes" class="input" rows="3" placeholder="Notes sur la séance">${entry.notes || ''}</textarea>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn btn-primary" onclick="app.saveHistoryEdit('${entry.id}')" style="flex: 1;">💾 Enregistrer</button>
                                <button class="btn btn-warning" onclick="app.cancelHistoryEdit()" style="flex: 1;">❌ Annuler</button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderPhotosTab() {
                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">📸 Photos Avant / Après</h2>
                        <div class="photo-gallery">
                            <div class="photo-item">
                                <h3 class="text-white mb-2" style="font-size: 1.1rem;">📷 AVANT</h3>
                                ${this.progressPhotos.before ? `
                                    <img src="${this.progressPhotos.before}" alt="Avant">
                                    <button class="btn btn-danger" style="width: 100%;" onclick="app.deletePhoto('before')">🗑️ Supprimer</button>
                                ` : `
                                    <input type="file" id="photo-before-input" accept="image/*" style="display: none;">
                                    <div class="photo-placeholder" onclick="document.getElementById('photo-before-input').click()">📷</div>
                                    <button class="btn btn-primary" style="width: 100%; margin-top: 0.75rem;" onclick="document.getElementById('photo-before-input').click()">➕ Ajouter</button>
                                `}
                            </div>
                            <div class="photo-item">
                                <h3 class="text-white mb-2" style="font-size: 1.1rem;">📷 APRÈS</h3>
                                ${this.progressPhotos.after ? `
                                    <img src="${this.progressPhotos.after}" alt="Après">
                                    <button class="btn btn-danger" style="width: 100%;" onclick="app.deletePhoto('after')">🗑️ Supprimer</button>
                                ` : `
                                    <input type="file" id="photo-after-input" accept="image/*" style="display: none;">
                                    <div class="photo-placeholder" onclick="document.getElementById('photo-after-input').click()">📷</div>
                                    <button class="btn btn-primary" style="width: 100%; margin-top: 0.75rem;" onclick="document.getElementById('photo-after-input').click()">➕ Ajouter</button>
                                `}
                            </div>
                        </div>
                        ${this.progressPhotos.before && this.progressPhotos.after ? `
                            <div class="tip-box" style="border-color: #10b981; background: rgba(16, 185, 129, 0.1);">
                                <div class="text-white" style="font-weight: 600; margin-bottom: 0.5rem;">🎉 Bravo !</div>
                                <div class="text-white" style="opacity: 0.9;">Vous avez ajouté vos photos avant/après. Continuez vos efforts !</div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }


            loadObjectifs() {
                if (!this.currentUser) return;
                const result = storage.get('objectifs');
                if (result.exists) {
                    this.objectifs = JSON.parse(result.value);
                } else {
                    // Objectifs par défaut
                    this.objectifs = [
                        {id: 1, titre: '10 séances ce mois', type: 'seances', cible: 10, actuel: 0, completed: false},
                        {id: 2, titre: 'Augmenter Développé Couché de 5kg', type: 'rm', muscle: 'Pectoraux', exercice: 'Développé Couché', cible: 5, actuel: 0, completed: false},
                        {id: 3, titre: 'Streak de 7 jours', type: 'streak', cible: 7, actuel: 0, completed: false}
                    ];
                }
            }

            saveObjectifs() {
                storage.save('objectifs', this.objectifs);
            }

            calculateStreaks() {
                if (!this.sessionHistory || this.sessionHistory.length === 0) {
                    this.currentStreak = 0;
                    this.longestStreak = 0;
                    return;
                }

                const completedDates = this.sessionHistory
                    .filter(h => h.completed)
                    .map(h => {
                        const d = new Date(h.completedAt);
                        return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
                    })
                    .filter((v, i, a) => a.indexOf(v) === i)
                    .sort((a, b) => b - a);

                if (completedDates.length === 0) {
                    this.currentStreak = 0;
                    this.longestStreak = 0;
                    return;
                }

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayTime = today.getTime();
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayTime = yesterday.getTime();

                let currentStreak = 0;
                let longestStreak = 0;
                let tempStreak = 1;

                if (completedDates[0] === todayTime || completedDates[0] === yesterdayTime) {
                    currentStreak = 1;
                    let checkDate = completedDates[0];
                    
                    for (let i = 1; i < completedDates.length; i++) {
                        const expectedPrevDay = checkDate - (24 * 60 * 60 * 1000);
                        if (completedDates[i] === expectedPrevDay) {
                            currentStreak++;
                            checkDate = completedDates[i];
                        } else {
                            break;
                        }
                    }
                }

                for (let i = 0; i < completedDates.length - 1; i++) {
                    const diff = completedDates[i] - completedDates[i + 1];
                    if (diff === 24 * 60 * 60 * 1000) {
                        tempStreak++;
                    } else {
                        longestStreak = Math.max(longestStreak, tempStreak);
                        tempStreak = 1;
                    }
                }
                longestStreak = Math.max(longestStreak, tempStreak);

                this.currentStreak = currentStreak;
                this.longestStreak = Math.max(longestStreak, currentStreak);
            }

            addObjectif(titre, type, cible, muscle = null, exercice = null) {
                const newId = this.objectifs.length > 0 ? Math.max(...this.objectifs.map(o => o.id)) + 1 : 1;
                const newObjectif = {
                    id: newId,
                    titre,
                    type,
                    cible,
                    actuel: 0,
                    completed: false,
                    muscle,
                    exercice,
                    createdAt: new Date().toISOString()
                };
                this.objectifs.push(newObjectif);
                this.saveObjectifs();
                this.render();
            }

            deleteObjectif(id) {
                if (confirm('Supprimer cet objectif ?')) {
                    this.objectifs = this.objectifs.filter(o => o.id !== id);
                    this.saveObjectifs();
                    this.render();
                }
            }

            updateObjectifProgress() {
                const thisMonth = new Date().getMonth();
                const thisYear = new Date().getFullYear();
                const sessionsThisMonth = this.sessionHistory.filter(h => {
                    const date = new Date(h.completedAt);
                    return h.completed && date.getMonth() === thisMonth && date.getFullYear() === thisYear;
                }).length;

                this.objectifs.forEach(obj => {
                    if (obj.type === 'seances') {
                        obj.actuel = sessionsThisMonth;
                        obj.completed = obj.actuel >= obj.cible;
                    } else if (obj.type === 'streak') {
                        obj.actuel = this.currentStreak;
                        obj.completed = obj.actuel >= obj.cible;
                    } else if (obj.type === 'rm' && obj.muscle && obj.exercice) {
                        const tests = this.rmHistory.filter(t => t.muscle === obj.muscle && t.exercise === obj.exercice);
                        if (tests.length >= 2) {
                            const sorted = tests.sort((a, b) => new Date(b.date) - new Date(a.date));
                            const latest = sorted[0].rm;
                            const initial = sorted[sorted.length - 1].rm;
                            obj.actuel = latest - initial;
                            obj.completed = obj.actuel >= obj.cible;
                        }
                    }
                });

                this.saveObjectifs();
            }

            renderObjectifsTab() {
                this.updateObjectifProgress();
                
                const objectifsActifs = this.objectifs.filter(o => !o.completed);
                const objectifsCompletes = this.objectifs.filter(o => o.completed);

                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">🎯 Mes Objectifs</h2>
                        
                        <!-- Streaks -->
                        <div class="mb-4" style="background: linear-gradient(135deg, rgba(251, 146, 60, 0.2) 0%, rgba(249, 115, 22, 0.2) 100%); border: 2px solid rgba(251, 146, 60, 0.4); border-radius: 1.5rem; padding: 2rem;">
                            <h3 class="text-white mb-3" style="font-size: 1.3rem;">🔥 Séries en cours</h3>
                            <div class="grid grid-cols-2 gap-3">
                                <div class="text-center" style="background: rgba(15, 23, 42, 0.6); padding: 1.5rem; border-radius: 1rem;">
                                    <div style="color: #fb923c; font-size: 3rem; font-weight: bold;">${this.currentStreak}</div>
                                    <div class="text-white" style="opacity: 0.9;">Jours consécutifs</div>
                                    ${this.currentStreak > 0 ? '<div class="text-cyan mt-2">🔥 Continue !</div>' : '<div class="text-white mt-2" style="opacity: 0.6;">Commence une série</div>'}
                                </div>
                                <div class="text-center" style="background: rgba(15, 23, 42, 0.6); padding: 1.5rem; border-radius: 1rem;">
                                    <div style="color: #fb923c; font-size: 3rem; font-weight: bold;">${this.longestStreak}</div>
                                    <div class="text-white" style="opacity: 0.9;">Record personnel</div>
                                    ${this.currentStreak === this.longestStreak && this.currentStreak > 0 ? '<div class="text-cyan mt-2">🏆 Nouveau record !</div>' : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Objectifs actifs -->
                        ${objectifsActifs.length > 0 ? `
                            <div class="mb-4">
                                <h3 class="text-white mb-3" style="font-size: 1.2rem;">🎯 En cours (${objectifsActifs.length})</h3>
                                ${objectifsActifs.map(obj => {
                                    const progress = Math.min((obj.actuel / obj.cible) * 100, 100);
                                    return `
                                        <div class="exercise-card" style="position: relative;">
                                            <div class="flex justify-between items-start mb-2">
                                                <h4 class="text-white" style="margin: 0;">${obj.titre}</h4>
                                                <button class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.9rem;" onclick="app.deleteObjectif(${obj.id})">🗑️</button>
                                            </div>
                                            <div class="mb-2">
                                                <div class="progress-bar">
                                                    <div class="progress-fill" style="width: ${progress}%;"></div>
                                                </div>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-white" style="opacity: 0.9;">${obj.actuel} / ${obj.cible}</span>
                                                <span class="text-cyan" style="font-weight: 600;">${Math.round(progress)}%</span>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="tip-box mb-4">
                                <div class="text-white" style="opacity: 0.7;">Aucun objectif actif. Crée-en un ci-dessous !</div>
                            </div>
                        `}

                        <!-- Objectifs complétés -->
                        ${objectifsCompletes.length > 0 ? `
                            <div class="mb-4">
                                <h3 class="text-white mb-3" style="font-size: 1.2rem;">✅ Complétés (${objectifsCompletes.length})</h3>
                                ${objectifsCompletes.map(obj => `
                                    <div class="exercise-card" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.1) 100%); border: 1px solid rgba(16, 185, 129, 0.3);">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <h4 class="text-white" style="margin: 0 0 0.5rem 0;">✅ ${obj.titre}</h4>
                                                <div style="color: #10b981; font-weight: 600;">${obj.actuel} / ${obj.cible} - 100%</div>
                                            </div>
                                            <button class="btn btn-danger" style="padding: 0.25rem 0.75rem; font-size: 0.9rem;" onclick="app.deleteObjectif(${obj.id})">🗑️</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}

                        <!-- Ajouter un objectif -->
                        <div class="exercise-card" style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.2) 0%, rgba(8, 145, 178, 0.1) 100%); border: 2px dashed rgba(6, 182, 212, 0.5);">
                            <h3 class="text-white mb-3" style="font-size: 1.2rem;">➕ Créer un objectif</h3>
                            <form id="objectif-form" onsubmit="app.handleAddObjectif(event)">
                                <div class="mb-3">
                                    <label class="text-white mb-1" style="display: block;">Type d'objectif</label>
                                    <select class="input" id="objectif-type" onchange="app.updateObjectifForm()">
                                        <option value="seances">📅 Nombre de séances ce mois</option>
                                        <option value="streak">🔥 Série de jours consécutifs</option>
                                        <option value="rm">💪 Augmenter un 1RM</option>
                                    </select>
                                </div>
                                <div id="objectif-rm-fields" style="display: none;">
                                    <div class="grid grid-cols-2 gap-2 mb-3">
                                        <div>
                                            <label class="text-white mb-1" style="display: block; font-size: 0.9rem;">Muscle</label>
                                            <select class="input" id="objectif-muscle">
                                                ${this.musclesList.map(m => `<option value="${m}">${m}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-white mb-1" style="display: block; font-size: 0.9rem;">Exercice</label>
                                            <input type="text" class="input" id="objectif-exercice" placeholder="Ex: Développé Couché">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="text-white mb-1" style="display: block;">Objectif cible</label>
                                    <input type="number" class="input" id="objectif-cible" min="1" required>
                                </div>
                                <button type="submit" class="btn btn-success" style="width: 100%;">➕ Créer l'objectif</button>
                            </form>
                        </div>

                        <div class="tip-box mt-4">
                            <div class="text-white" style="font-weight: 600; margin-bottom: 0.5rem;">💡 Conseils</div>
                            <ul style="margin: 0; padding-left: 1.5rem;">
                                <li class="text-white" style="opacity: 0.9; margin-bottom: 0.5rem;">Fixe-toi des objectifs réalistes et progressifs</li>
                                <li class="text-white" style="opacity: 0.9; margin-bottom: 0.5rem;">Les séries motivent énormément - essaie de maintenir une régularité</li>
                                <li class="text-white" style="opacity: 0.9;">Célèbre chaque victoire, même les petites !</li>
                            </ul>
                        </div>
                    </div>
                `;
            }

            updateObjectifForm() {
                const type = document.getElementById('objectif-type').value;
                const rmFields = document.getElementById('objectif-rm-fields');
                const cibleInput = document.getElementById('objectif-cible');
                
                if (type === 'rm') {
                    rmFields.style.display = 'block';
                    cibleInput.placeholder = 'Progression en kg (ex: 5)';
                } else if (type === 'seances') {
                    rmFields.style.display = 'none';
                    cibleInput.placeholder = 'Nombre de séances (ex: 10)';
                } else if (type === 'streak') {
                    rmFields.style.display = 'none';
                    cibleInput.placeholder = 'Nombre de jours (ex: 7)';
                }
            }

            handleAddObjectif(e) {
                e.preventDefault();
                const type = document.getElementById('objectif-type').value;
                const cible = parseInt(document.getElementById('objectif-cible').value);
                
                let titre = '';
                let muscle = null;
                let exercice = null;
                
                if (type === 'seances') {
                    titre = `${cible} séances ce mois`;
                } else if (type === 'streak') {
                    titre = `Série de ${cible} jours`;
                } else if (type === 'rm') {
                    muscle = document.getElementById('objectif-muscle').value;
                    exercice = document.getElementById('objectif-exercice').value;
                    if (!exercice) {
                        alert('Remplis le nom de l\'exercice');
                        return;
                    }
                    titre = `Augmenter ${exercice} de ${cible}kg`;
                }
                
                this.addObjectif(titre, type, cible, muscle, exercice);
                document.getElementById('objectif-form').reset();
                this.updateObjectifForm();
            }
            renderBadgesTab() {
                const unlockedCount = this.badges.filter(b => b.unlocked).length;
                const totalCount = this.badges.length;
                const progressPercent = Math.round((unlockedCount / totalCount) * 100);

                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">🏆 Mes Badges (${unlockedCount}/${totalCount})</h2>
                        <div class="mb-4">
                            <div class="text-white mb-2" style="font-weight: 600;">Progression globale : ${progressPercent}%</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${progressPercent}%;"></div>
                            </div>
                        </div>
                        <div class="badge-grid">
                            ${this.badges.map(badge => `
                                <div class="badge-item ${badge.unlocked ? 'unlocked' : 'locked'}">
                                    <div class="badge-icon">${badge.icon}</div>
                                    <div class="text-white" style="font-weight: 600; margin-bottom: 0.5rem;">${badge.name}</div>
                                    <div class="text-white" style="opacity: 0.7; font-size: 0.85rem; margin-bottom: 0.5rem;">${badge.description}</div>
                                    ${badge.unlocked ? `<div class="text-cyan" style="font-size: 0.8rem;">✓ Débloqué le ${new Date(badge.unlockedAt).toLocaleDateString('fr-FR')}</div>` : `<div class="text-white" style="opacity: 0.5; font-size: 0.8rem;">🔒 Verrouillé</div>`}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            renderCoursTab() {
                const allExercises = [
                    ...coursData.exercicesPectoraux,
                    ...coursData.exercicesDos,
                    ...coursData.exercicesEpaules,
                    ...coursData.exercicesBras,
                    ...coursData.exercicesBasDuCorps,
                    ...coursData.exercicesAbdos
                ];
                const filteredExercises = this.filterExercises(allExercises);

                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">📚 Cours & Ressources</h2>
                        <div class="flex gap-2 mb-4" style="overflow-x: auto;">
                            <button class="sub-tab-btn ${this.currentCoursTab === 'principes' ? 'active' : ''}" onclick="app.switchCoursTab('principes')">📖 Principes</button>
                            <button class="sub-tab-btn ${this.currentCoursTab === 'mobiles' ? 'active' : ''}" onclick="app.switchCoursTab('mobiles')">🎯 Mobiles</button>
                            <button class="sub-tab-btn ${this.currentCoursTab === 'formes' ? 'active' : ''}" onclick="app.switchCoursTab('formes')">🏋️ Formes</button>
                            <button class="sub-tab-btn ${this.currentCoursTab === 'contractions' ? 'active' : ''}" onclick="app.switchCoursTab('contractions')">💪 Contractions</button>
                            <button class="sub-tab-btn ${this.currentCoursTab === 'hygiene' ? 'active' : ''}" onclick="app.switchCoursTab('hygiene')">🧘 Hygiène</button>
                            <button class="sub-tab-btn ${this.currentCoursTab === 'anatomie' ? 'active' : ''}" onclick="app.switchCoursTab('anatomie')">🫀 Anatomie</button>
                            <button class="sub-tab-btn ${this.currentCoursTab === 'exercices' ? 'active' : ''}" onclick="app.switchCoursTab('exercices')">🏋️ Exercices</button>
                        </div>
                        ${this.currentCoursTab === 'principes' ? this.renderPrincipesTab() : ''}
                        ${this.currentCoursTab === 'mobiles' ? this.renderMobilesTab() : ''}
                        ${this.currentCoursTab === 'formes' ? this.renderFormesTab() : ''}
                        ${this.currentCoursTab === 'contractions' ? this.renderContractionsTab() : ''}
                        ${this.currentCoursTab === 'hygiene' ? this.renderHygieneTab() : ''}
                        ${this.currentCoursTab === 'anatomie' ? this.renderAnatomieTab() : ''}
                        ${this.currentCoursTab === 'exercices' ? this.renderExercicesTab(filteredExercises) : ''}
                    </div>
                `;
            }

            filterExercises(exercises) {
                let filtered = exercises;
                if (this.searchQuery) {
                    const query = this.searchQuery.toLowerCase();
                    filtered = filtered.filter(ex => 
                        ex.nom.toLowerCase().includes(query) || 
                        ex.description.toLowerCase().includes(query)
                    );
                }
                if (this.activeFilters.length > 0) {
                    const muscleMap = {
                        'Pectoraux': coursData.exercicesPectoraux,
                        'Dos': coursData.exercicesDos,
                        'Épaules': coursData.exercicesEpaules,
                        'Bras': coursData.exercicesBras,
                        'Bas du corps': coursData.exercicesBasDuCorps,
                        'Abdos': coursData.exercicesAbdos
                    };
                    filtered = filtered.filter(ex => 
                        this.activeFilters.some(filter => 
                            muscleMap[filter] && muscleMap[filter].includes(ex)
                        )
                    );
                }
                return filtered;
            }

            renderExercicesTab(filteredExercises) {
                const filters = ['Pectoraux', 'Dos', 'Épaules', 'Bras', 'Bas du corps', 'Abdos'];
                return `
                    <div>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <span class="search-icon">🔍</span>
                                <input type="text" class="search-input" placeholder="Rechercher un exercice..." value="${this.searchQuery}" oninput="app.updateSearchQuery(this.value)">
                            </div>
                            <div class="filter-chips">
                                ${filters.map(filter => `<button class="filter-chip ${this.activeFilters.includes(filter) ? 'active' : ''}" onclick="app.toggleFilter('${filter}')">${filter}</button>`).join('')}
                            </div>
                        </div>
                        ${filteredExercises.length > 0 ? `
                            <div class="text-white mb-3" style="opacity: 0.7;">${filteredExercises.length} exercice${filteredExercises.length > 1 ? 's' : ''}</div>
                            ${filteredExercises.map(ex => `
                                <div class="exercise-card">
                                    <h4>${ex.nom}</h4>
                                    <p class="text-white" style="opacity: 0.9; margin-bottom: 1rem;">${ex.description}</p>
                                    ${ex.technique ? `<div class="mb-3"><div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">📋 Technique :</div><ul>${ex.technique.map(t => `<li>${t}</li>`).join('')}</ul></div>` : ''}
                                    ${ex.variantes ? `<div class="mb-3"><div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">🔄 Variantes :</div><div class="text-white" style="opacity: 0.9;">${ex.variantes.join(' • ')}</div></div>` : ''}
                                </div>
                                    ${ex.video ? `<a href="${ex.video}" target="_blank" class="btn btn-primary" style="text-decoration: none;">🎥 Voir la vidéo</a>` : ""}
                                    ${ex.videos ? `<div class="flex gap-2">${ex.videos.map((vid, idx) => `<a href="${vid}" target="_blank" class="btn btn-primary" style="text-decoration: none; flex: 1;">🎥 Vidéo ${idx + 1}</a>`).join("")}</div>` : ""}
                            `).join('')}
                        ` : `<div class="no-results"><div class="no-results-icon">🔍</div><div class="text-white" style="font-size: 1.2rem;">Aucun exercice</div></div>`}
                    </div>
                `;
            }

            renderPrincipesTab() {
                return `<div>${coursData.principes.map(p => `<div class="exercise-card"><h4>${p.titre}</h4><p class="text-white" style="opacity: 0.9; margin-bottom: 1rem;">${p.contenu}</p><div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">💡 Conseils :</div><ul>${p.conseils.map(c => `<li>${c}</li>`).join('')}</ul></div>`).join('')}</div>`;
            }

            renderMobilesTab() {
                return `<div>${coursData.mobiles.map(m => `
                    <div class="exercise-card" style="border-left: 4px solid ${m.color};">
                        <h4 style="color: ${m.color}; font-size: 1.3rem; margin-bottom: 1rem;">${m.nom}</h4>
                        
                        ${m.definition ? `
                            <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;">
                                <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">📖 Définition</div>
                                <p class="text-white" style="opacity: 0.9;">${m.definition}</p>
                            </div>
                        ` : ''}
                        
                        <div style="background: linear-gradient(135deg, ${m.color}20 0%, ${m.color}10 100%); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;">
                            <div class="text-white" style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.75rem;">🎯 ${m.objectif}</div>
                            <table class="mobile-table">
                                <tr><th>💪 Charge</th><td>${m.charge}</td></tr>
                                <tr><th>🔢 Répétitions</th><td>${m.repetitions}</td></tr>
                                <tr><th>📊 Séries</th><td>${m.series}</td></tr>
                                <tr><th>⏱️ Repos</th><td>${m.repos}</td></tr>
                                ${m.tempo ? `<tr><th>🎵 Tempo</th><td>${m.tempo}</td></tr>` : ''}
                            </table>
                        </div>
                        
                        ${m.avantages ? `
                            <div style="margin-bottom: 1rem;">
                                <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">✅ Avantages</div>
                                <ul style="margin-left: 1.5rem;">
                                    ${m.avantages.map(a => `<li class="text-white" style="opacity: 0.9; margin-bottom: 0.25rem;">${a}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${m.inconvenients ? `
                            <div style="margin-bottom: 1rem;">
                                <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">⚠️ Inconvénients</div>
                                <ul style="margin-left: 1.5rem;">
                                    ${m.inconvenients.map(i => `<li class="text-white" style="opacity: 0.9; margin-bottom: 0.25rem;">${i}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        
                        ${m.public ? `
                            <div style="background: rgba(6, 182, 212, 0.1); padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--primary-color);">
                                <div class="text-cyan" style="font-weight: 600; display: inline;">👥 Public concerné : </div>
                                <span class="text-white" style="opacity: 0.9;">${m.public}</span>
                            </div>
                        ` : ''}
                        
                        ${m.exemple ? `
                            <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;">
                                <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">📝 Exemple concret</div>
                                <p class="text-white" style="opacity: 0.9; line-height: 1.6;">${m.exemple}</p>
                            </div>
                        ` : ''}
                        
                        <div>
                            <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">🏋️ Formes d'entraînement associées</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${m.formes.map(f => `<span style="background: ${m.color}30; color: ${m.color}; padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.9rem; font-weight: 500;">${f}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `).join('')}</div>`;
            }

            renderContractionsTab() {
                return `<div>${coursData.typesContraction.map(t => `<div class="exercise-card"><h4>${t.type}</h4><p class="text-white" style="opacity: 0.9;"><strong>Définition :</strong> ${t.definition}</p><p class="text-cyan"><strong>Exemple :</strong> ${t.exemple}</p><p class="text-white" style="opacity: 0.8;"><strong>Mobile :</strong> ${t.mobile}</p></div>`).join('')}</div>`;
            }

            renderFormesTab() {
                return `<div>${coursData.formesEntrainement.map(f => `
                    <div class="exercise-card">
                        <h4 style="font-size: 1.3rem; margin-bottom: 1rem; color: var(--primary-color);">${f.nom}</h4>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;">
                            <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">📖 Définition</div>
                            <p class="text-white" style="opacity: 0.9;">${f.definition}</p>
                        </div>
                        
                        <div style="background: rgba(6, 182, 212, 0.1); padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--primary-color);">
                            <div class="text-cyan" style="font-weight: 600; display: inline;">📐 Structure : </div>
                            <span class="text-white" style="opacity: 0.9;">${f.structure}</span>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">✅ Avantages</div>
                            <ul style="margin-left: 1.5rem;">
                                ${f.avantages.map(a => `<li class="text-white" style="opacity: 0.9; margin-bottom: 0.25rem;">${a}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">⚠️ Inconvénients</div>
                            <ul style="margin-left: 1.5rem;">
                                ${f.inconvenients.map(i => `<li class="text-white" style="opacity: 0.9; margin-bottom: 0.25rem;">${i}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <div style="background: rgba(6, 182, 212, 0.1); padding: 0.75rem 1rem; border-radius: 0.5rem; margin-bottom: 1rem; border-left: 3px solid var(--primary-color);">
                            <div class="text-cyan" style="font-weight: 600; display: inline;">👥 Public concerné : </div>
                            <span class="text-white" style="opacity: 0.9;">${f.public}</span>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); padding: 1rem; border-radius: 0.75rem;">
                            <div class="text-cyan" style="font-weight: 600; margin-bottom: 0.5rem;">📝 Exemple concret</div>
                            <p class="text-white" style="opacity: 0.9; line-height: 1.6;">${f.exemple}</p>
                        </div>
                    </div>
                `).join('')}</div>`;
            }

            renderHygieneTab() {
                return `<div><div class="content-section"><h3 class="text-white mb-3" style="font-size: 1.3rem;">✅ Avant</h3>${coursData.hygiene.avant.map(i => `<div class="exercise-card"><h4>${i.titre}</h4><p class="text-white" style="opacity: 0.9;">${i.contenu}</p></div>`).join('')}</div><div class="content-section"><h3 class="text-white mb-3" style="font-size: 1.3rem;">💪 Pendant</h3>${coursData.hygiene.pendant.map(i => `<div class="exercise-card"><h4>${i.titre}</h4><p class="text-white" style="opacity: 0.9;">${i.contenu}</p></div>`).join('')}</div><div class="content-section"><h3 class="text-white mb-3" style="font-size: 1.3rem;">🧘 Après</h3>${coursData.hygiene.apres.map(i => `<div class="exercise-card"><h4>${i.titre}</h4><p class="text-white" style="opacity: 0.9;">${i.contenu}</p></div>`).join('')}</div></div>`;
            }

            renderAnatomieTab() {
                // Liste complète des muscles avec leurs infos
                const allMuscles = {
                    "Pectoraux": {
                        role: "Adduction, flexion et rotation interne épaule. Mouvements de poussée.",
                        insertions: ["Clavicule, sternum → Humérus", "3 faisceaux: haut, milieu, bas"]
                    },
                    "Grand Dorsal": {
                        role: "Extension, adduction épaule. Forme en V du dos.",
                        insertions: ["Vertèbres, crête iliaque → Humérus", "Travaillé en traction"]
                    },
                    "Trapèze": {
                        role: "Élévation, abaissement, rétraction omoplates. Posture.",
                        insertions: ["3 faisceaux: supérieur, moyen, inférieur", "Crâne, vertèbres → Omoplate"]
                    },
                    "Deltoïde": {
                        role: "Abduction, flexion, extension épaule. Largeur épaules.",
                        insertions: ["3 faisceaux: antérieur, moyen, postérieur", "Clavicule, omoplate → Humérus"]
                    },
                    "Biceps": {
                        role: "Flexion coude et supination avant-bras.",
                        insertions: ["2 chefs depuis omoplate → Radius", "Synergiste: brachial"]
                    },
                    "Triceps": {
                        role: "Extension coude. 2/3 du volume du bras.",
                        insertions: ["3 chefs: long, latéral, médial", "Omoplate, humérus → Ulna"]
                    },
                    "Quadriceps": {
                        role: "Extension genou, flexion hanche. Plus puissant muscle.",
                        insertions: ["4 chefs: droit fémoral + 3 vastes", "Bassin, fémur → Rotule → Tibia"]
                    },
                    "Ischio-Jambiers": {
                        role: "Flexion genou, extension hanche. Antagonistes quadriceps.",
                        insertions: ["3 muscles", "Ischion → Tibia, fibula"]
                    },
                    "Fessiers": {
                        role: "Extension, abduction, rotation hanche. Muscle le plus puissant.",
                        insertions: ["Grand, moyen, petit fessier", "Iliaque, sacrum → Fémur"]
                    },
                    "Adducteurs": {
                        role: "Adduction de la hanche (rapproche jambes). Stabilisation du bassin.",
                        insertions: ["5 muscles: court, long, grand, pectiné, gracile", "Pubis → Fémur"]
                    },
                    "Mollets": {
                        role: "Flexion plantaire cheville. Propulsion marche/course.",
                        insertions: ["Gastrocnémien (2 chefs) + Soléaire", "Fémur, tibia → Calcanéus (tendon d'Achille)"]
                    },
                    "Abdos": {
                        role: "Flexion du tronc. Stabilisation du bassin et de la colonne.",
                        insertions: ["Grand droit (6 pack)", "Côtes → Pubis"]
                    },
                    "Obliques": {
                        role: "Rotation et flexion latérale du tronc. Stabilisation.",
                        insertions: ["Obliques externes et internes", "Côtes → Bassin, aponévrose"]
                    },
                    "Grand Droit": {
                        role: "Flexion du tronc. Rapproche le sternum du pubis.",
                        insertions: ["Muscles des abdominaux (rectus abdominis)", "5ème, 6ème et 7ème côtes → Pubis"]
                    }
                };
                
                return `
                    <div>
                        <h3 class="text-white mb-3" style="font-size: 1.3rem;">📚 Planches Anatomiques</h3>
                        <div class="grid grid-cols-2 gap-3 mb-4">
                            <div style="background: rgba(15, 23, 42, 0.6); border-radius: 1rem; padding: 1rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                                <h4 class="text-white mb-2" style="text-align: center; font-size: 1.1rem;">Vue de Face</h4>
                                <img src="images/planche_anatomique_face.PNG" alt="Planche anatomique face" style="width: 100%; border-radius: 0.75rem;">
                            </div>
                            <div style="background: rgba(15, 23, 42, 0.6); border-radius: 1rem; padding: 1rem; border: 1px solid rgba(148, 163, 184, 0.2);">
                                <h4 class="text-white mb-2" style="text-align: center; font-size: 1.1rem;">Vue de Dos</h4>
                                <img src="images/planche_anatomique_dos.PNG" alt="Planche anatomique dos" style="width: 100%; border-radius: 0.75rem;">
                            </div>
                        </div>
                        
                        <h3 class="text-white mb-3 mt-4" style="font-size: 1.3rem;">💪 Groupes Musculaires</h3>
                        ${Object.entries(allMuscles).map(([muscleName, info]) => `
                            <div class="muscle-info-card">
                                <h4>${muscleName}</h4>
                                <div class="muscle-info-section">
                                    <h5>🎯 Rôle</h5>
                                    <p>${info.role}</p>
                                </div>
                                <div class="muscle-info-section">
                                    <h5>📍 Insertions</h5>
                                    <ul>
                                        ${info.insertions.map(ins => `<li>${ins}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderSessionForm() {
                const isEditing = this.currentSession !== null;
                
                // Si édition, charger les données
                if (isEditing) {
                    const session = this.sessions[this.currentSession];
                    if (this.sessionStep === 1) {
                        this.sessionNomTemp = session.nom;
                        this.sessionMobileTemp = session.type;
                    }
                    if (this.exercicesDetails.length === 0) {
                        this.exercicesDetails = session.exercicesDetails || [];
                    }
                }
                
                return `
                    <div class="container">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-white" style="font-size: 1.5rem;">${isEditing ? '✏️ Modifier' : '➕ Créer'} une séance</h2>
                                <button class="btn btn-secondary" onclick="app.cancelSession()">← Retour</button>
                            </div>
                            
                            <!-- Indicateur d'étapes -->
                            <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem;">
                                <div style="flex: 1; text-align: center;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; ${this.sessionStep >= 1 ? 'background: var(--primary-color); color: #0f172a;' : 'background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);'}">1</div>
                                    <div class="text-white" style="font-size: 0.85rem; opacity: ${this.sessionStep >= 1 ? '1' : '0.5'}">Infos</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; ${this.sessionStep >= 2 ? 'background: var(--primary-color); color: #0f172a;' : 'background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);'}">2</div>
                                    <div class="text-white" style="font-size: 0.85rem; opacity: ${this.sessionStep >= 2 ? '1' : '0.5'}">Exercices</div>
                                </div>
                                <div style="flex: 1; text-align: center;">
                                    <div style="width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 0.5rem; display: flex; align-items: center; justify-content: center; font-weight: 600; ${this.sessionStep >= 3 ? 'background: var(--primary-color); color: #0f172a;' : 'background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.5);'}">3</div>
                                    <div class="text-white" style="font-size: 0.85rem; opacity: ${this.sessionStep >= 3 ? '1' : '0.5'}">Validation</div>
                                </div>
                            </div>
                            
                            ${this.renderSessionStep()}
                        </div>
                    </div>
                `;
            }

            renderSessionStep() {
                if (this.sessionStep === 1) {
                    return this.renderStep1();
                } else if (this.sessionStep === 2) {
                    return this.renderStep2();
                } else {
                    return this.renderStep3();
                }
            }

            renderStep1() {
                return `
                    <div style="background: rgba(6, 182, 212, 0.1); padding: 2rem; border-radius: 1rem; border: 2px solid var(--primary-color);">
                        <h3 class="text-cyan mb-4" style="font-size: 1.3rem;">📋 Étape 1 : Informations de la séance</h3>
                        
                        <div class="mb-4">
                            <label class="text-white mb-2" style="display: block; font-weight: 600; font-size: 1.1rem;">Nom de la séance *</label>
                            <input 
                                type="text" 
                                class="input" 
                                id="session-name-step1" 
                                placeholder="Ex: Upper Push A, Jambes Force, FullBody..." 
                                value="${this.sessionNomTemp}"
                                style="font-size: 1.1rem;"
                            >
                            <div class="text-white" style="opacity: 0.6; font-size: 0.85rem; margin-top: 0.5rem;">
                                💡 Choisis un nom clair pour retrouver facilement ta séance
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="text-white mb-2" style="display: block; font-weight: 600; font-size: 1.1rem;">Mobile d'entraînement *</label>
                            <select class="input" id="session-mobile-step1" style="font-size: 1.1rem;">
                                <option value="Force Maximale" ${this.sessionMobileTemp === 'Force Maximale' ? 'selected' : ''}>💪 Force Maximale</option>
                                <option value="Force Explosive" ${this.sessionMobileTemp === 'Force Explosive' ? 'selected' : ''}>⚡ Force Explosive</option>
                                <option value="Hypertrophie" ${this.sessionMobileTemp === 'Hypertrophie' ? 'selected' : ''}>🏋️ Hypertrophie</option>
                                <option value="Endurance de Force" ${this.sessionMobileTemp === 'Endurance de Force' ? 'selected' : ''}>🔥 Endurance de Force</option>
                                <option value="Endurance Musculaire" ${this.sessionMobileTemp === 'Endurance Musculaire' ? 'selected' : ''}>🏃 Endurance Musculaire</option>
                                <option value="Personnalisé" ${this.sessionMobileTemp === 'Personnalisé' ? 'selected' : ''}>⚙️ Personnalisé</option>
                            </select>
                            <div class="text-white" style="opacity: 0.6; font-size: 0.85rem; margin-top: 0.5rem;">
                                ℹ️ Le mobile est indicatif, tu personnaliseras chaque exercice à l'étape suivante
                            </div>
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="app.validateStep1()" style="width: 100%; font-size: 1.2rem; padding: 1rem;">
                            ✅ Valider et passer aux exercices →
                        </button>
                    </div>
                `;
            }

            renderStep2() {
                return `
                    <!-- Résumé verrouillé -->
                    <div style="background: rgba(6, 182, 212, 0.15); padding: 1rem; border-radius: 0.75rem; margin-bottom: 2rem; border-left: 4px solid var(--primary-color);">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-cyan" style="font-weight: 600; font-size: 1.1rem;">📝 ${this.sessionNomTemp}</div>
                                <div class="text-white" style="opacity: 0.8; font-size: 0.9rem;">${this.sessionMobileTemp}</div>
                            </div>
                            <button type="button" class="btn btn-secondary" onclick="app.backToStep1()" style="padding: 0.5rem 1rem;">✏️ Modifier</button>
                        </div>
                    </div>
                    
                    <!-- Formulaire d'ajout d'exercice -->
                    <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 1rem; border: 2px solid #a855f7; margin-bottom: 2rem;">
                        <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">💪 Ajouter un exercice</h3>
                        
                        <div class="mb-3">
                            <label class="text-white mb-1" style="display: block; font-weight: 600;">1. Groupe musculaire</label>
                            <select class="input" id="exercice-muscle" onchange="app.updateExercicesList()">
                                <option value="">-- Choisir --</option>
                                ${this.musclesList.map(m => `<option value="${m}">${m}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div class="mb-3" id="exercice-select-container" style="display: none;">
                            <label class="text-white mb-1" style="display: block; font-weight: 600;">2. Exercice</label>
                            <select class="input" id="exercice-name-select" onchange="app.toggleCustomExercice()">
                                <option value="">-- Choisir --</option>
                            </select>
                            <input 
                                type="text" 
                                class="input" 
                                id="exercice-name-custom" 
                                placeholder="Nom de l'exercice personnalisé" 
                                style="display: none; margin-top: 0.5rem;"
                            >
                        </div>
                        
                        <div id="exercice-details-container" style="display: none;">
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">3. Séries</label>
                                    <input type="number" class="input" id="exercice-series" value="4" min="1" max="10">
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">4. Répétitions</label>
                                    <input type="number" class="input" id="exercice-reps" value="10" min="1" max="50">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">5. Charge théorique (kg)</label>
                                    <input type="number" class="input" id="exercice-charge-theo" placeholder="Auto si 1RM" step="0.5">
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">6. Charge réelle (kg)</label>
                                    <input type="number" class="input" id="exercice-charge-reelle" placeholder="À charger" step="0.5">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">7. Tempo (optionnel)</label>
                                    <input type="text" class="input" id="exercice-tempo" placeholder="Ex: 3-1-1">
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">8. Récup (sec)</label>
                                    <input type="number" class="input" id="exercice-recup" value="90" min="0" max="600">
                                </div>
                            </div>
                            
                            <button type="button" class="btn btn-primary" onclick="app.addExerciceDetail()" style="width: 100%;">
                                ➕ Ajouter cet exercice
                            </button>
                        </div>
                    </div>
                    
                    <!-- Liste des exercices ajoutés -->
                    ${this.exercicesDetails.length > 0 ? `
                        <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 1rem; border: 2px solid #10b981; margin-bottom: 2rem;">
                            <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">📝 Exercices de la séance (${this.exercicesDetails.length})</h3>
                            ${this.exercicesDetails.map((ex, index) => `
                                <div style="background: rgba(15, 23, 42, 0.8); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem; border-left: 4px solid var(--primary-color);">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-white" style="font-weight: 600; font-size: 1.1rem;">${index + 1}. ${ex.nom}</div>
                                        <button type="button" class="btn btn-danger" style="padding: 0.5rem 1rem;" onclick="app.removeExerciceDetail(${index})">🗑️</button>
                                    </div>
                                    <div class="text-white" style="opacity: 0.8; font-size: 0.9rem;">
                                        <span style="color: var(--primary-color);">💪 ${ex.muscle}</span> • 
                                        ${ex.series}×${ex.reps} • 
                                        ${ex.chargeReelle ? ex.chargeReelle + 'kg' : 'PDC'} • 
                                        ${ex.recup}s repos
                                        ${ex.tempo ? ' • Tempo: ' + ex.tempo : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <button type="button" class="btn btn-success" onclick="app.validateStep2()" style="width: 100%; font-size: 1.2rem; padding: 1rem;">
                            ✅ Terminer et valider la séance →
                        </button>
                    ` : `
                        <div class="text-center" style="padding: 2rem; opacity: 0.5; background: rgba(15, 23, 42, 0.3); border-radius: 1rem; border: 2px dashed rgba(255,255,255,0.2);">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">📋</div>
                            <div class="text-white" style="font-size: 1.1rem;">Aucun exercice ajouté</div>
                            <div class="text-white" style="opacity: 0.7; font-size: 0.9rem; margin-top: 0.5rem;">Ajoute au moins un exercice pour continuer</div>
                        </div>
                    `}
                `;
            }

            renderStep3() {
                return `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">✅</div>
                        <h3 class="text-white mb-3" style="font-size: 1.5rem;">Séance créée avec succès !</h3>
                        <div class="text-cyan mb-4">${this.sessionNomTemp}</div>
                        <div class="text-white mb-4" style="opacity: 0.8;">${this.exercicesDetails.length} exercice${this.exercicesDetails.length > 1 ? 's' : ''} ajouté${this.exercicesDetails.length > 1 ? 's' : ''}</div>
                        <button type="button" class="btn btn-primary" onclick="app.goToSessions()" style="width: 100%; max-width: 300px; margin: 0 auto;">
                            📝 Voir mes séances
                        </button>
                    </div>
                `;
            }

            // ========== FONCTIONS DE GESTION DES ÉTAPES ==========

            validateStep1() {
                const nom = document.getElementById('session-name-step1').value.trim();
                const mobile = document.getElementById('session-mobile-step1').value;
                
                if (!nom) {
                    alert('⚠️ Entre un nom pour la séance');
                    return;
                }
                
                // Sauvegarder les données temporaires
                this.sessionNomTemp = nom;
                this.sessionMobileTemp = mobile;
                
                // Passer à l'étape 2
                this.sessionStep = 2;
                this.render();
                
                console.log('✅ Étape 1 validée:', nom, mobile);
            }

            backToStep1() {
                this.sessionStep = 1;
                this.render();
            }

            validateStep2() {
                if (this.exercicesDetails.length === 0) {
                    alert('⚠️ Ajoute au moins un exercice');
                    return;
                }
                
                // Créer la séance
                const session = {
                    nom: this.sessionNomTemp,
                    type: this.sessionMobileTemp,
                    exercicesDetails: [...this.exercicesDetails],
                    dateCreation: new Date().toISOString()
                };
                
                // Sauvegarder
                const isEditing = this.currentSession !== null;
                if (isEditing) {
                    this.sessions[this.currentSession] = session;
                    console.log('✏️ Séance modifiée');
                } else {
                    this.sessions.push(session);
                    console.log('➕ Nouvelle séance créée');
                }
                
                this.saveSessions();
                this.checkBadges();
                
                // Passer à l'étape 3 (confirmation)
                this.sessionStep = 3;
                this.render();
                
                console.log('✅ Étape 2 validée, séance sauvegardée');
            }

            goToSessions() {
                // Réinitialiser
                this.currentSession = null;
                this.exercicesDetails = [];
                this.sessionStep = 1;
                this.sessionNomTemp = '';
                this.sessionMobileTemp = 'Hypertrophie';
                
                // Retour aux séances
                this.currentView = 'dashboard';
                this.currentTab = 'sessions';
                this.render();
            }

            getExercicesByMuscle(muscle) {
                const exercicesMap = {
                    'Pectoraux': coursData.exercicesPectoraux,
                    'Grand dorsal': coursData.exercicesDos,
                    'Trapèzes': coursData.exercicesDos,
                    'Deltoïdes': coursData.exercicesEpaules,
                    'Biceps': coursData.exercicesBras,
                    'Triceps': coursData.exercicesBras,
                    'Abdominaux': coursData.exercicesAbdos,
                    'Quadriceps': coursData.exercicesBasDuCorps,
                    'Ischio-jambiers': coursData.exercicesBasDuCorps,
                    'Fessiers': coursData.exercicesBasDuCorps,
                    'Mollets': coursData.exercicesBasDuCorps,
                    'Adducteurs': coursData.exercicesBasDuCorps
                };
                
                const exercices = exercicesMap[muscle] || [];
                return exercices.map(ex => ex.nom);
            }

            updateExercicesList() {
                const muscle = document.getElementById('exercice-muscle').value;
                const selectContainer = document.getElementById('exercice-select-container');
                const select = document.getElementById('exercice-name-select');
                
                if (!muscle) {
                    selectContainer.style.display = 'none';
                    document.getElementById('exercice-details-container').style.display = 'none';
                    return;
                }
                
                // Afficher le select d'exercices
                selectContainer.style.display = 'block';
                
                // Remplir la liste des exercices
                const exercices = this.getExercicesByMuscle(muscle);
                select.innerHTML = `
                    <option value="">-- Choisir un exercice --</option>
                    ${exercices.map(ex => `<option value="${ex}">${ex}</option>`).join('')}
                    <option value="CUSTOM">✏️ Autre (exercice personnalisé)</option>
                `;
            }

            toggleCustomExercice() {
                const select = document.getElementById('exercice-name-select');
                const customInput = document.getElementById('exercice-name-custom');
                const detailsContainer = document.getElementById('exercice-details-container');
                
                if (select.value === 'CUSTOM') {
                    customInput.style.display = 'block';
                    customInput.focus();
                } else {
                    customInput.style.display = 'none';
                }
                
                // Afficher les détails si un exercice est sélectionné
                if (select.value) {
                    detailsContainer.style.display = 'block';
                } else {
                    detailsContainer.style.display = 'none';
                }
            }

            addExerciceDetail() {
                const muscle = document.getElementById('exercice-muscle').value;
                const selectValue = document.getElementById('exercice-name-select').value;
                const customValue = document.getElementById('exercice-name-custom').value.trim();
                const series = parseInt(document.getElementById('exercice-series').value);
                const reps = parseInt(document.getElementById('exercice-reps').value);
                const chargeTheo = parseFloat(document.getElementById('exercice-charge-theo').value) || null;
                const chargeReelle = parseFloat(document.getElementById('exercice-charge-reelle').value) || null;
                const tempo = document.getElementById('exercice-tempo').value.trim() || null;
                const recup = parseInt(document.getElementById('exercice-recup').value);
                
                // Validation
                if (!muscle) {
                    alert('⚠️ Sélectionne un groupe musculaire');
                    return;
                }
                
                const nomExercice = selectValue === 'CUSTOM' ? customValue : selectValue;
                if (!nomExercice) {
                    alert('⚠️ Choisis un exercice');
                    return;
                }
                
                // Créer l'objet exercice
                const exercice = {
                    muscle,
                    nom: nomExercice,
                    series,
                    reps,
                    chargeTheo,
                    chargeReelle,
                    tempo,
                    recup,
                    completed: false
                };
                
                this.exercicesDetails.push(exercice);
                
                // Réinitialiser le formulaire d'exercice sans recharger
                document.getElementById('exercice-muscle').value = '';
                document.getElementById('exercice-name-select').innerHTML = '<option value="">-- Choisir un exercice --</option>';
                document.getElementById('exercice-name-custom').value = '';
                document.getElementById('exercice-series').value = '4';
                document.getElementById('exercice-reps').value = '10';
                document.getElementById('exercice-charge-theo').value = '';
                document.getElementById('exercice-charge-reelle').value = '';
                document.getElementById('exercice-tempo').value = '';
                document.getElementById('exercice-recup').value = '90';
                document.getElementById('exercice-select-container').style.display = 'none';
                document.getElementById('exercice-name-custom').style.display = 'none';
                document.getElementById('exercice-details-container').style.display = 'none';
                
                // Recharger pour afficher la liste mise à jour
                this.render();
                
                console.log('✅ Exercice ajouté:', nomExercice);
            }

            removeExerciceDetail(index) {
                if (confirm('Supprimer cet exercice de la séance ?')) {
                    this.exercicesDetails.splice(index, 1);
                    this.render();
                }
            }

            editExerciceDetail(index) {
                // TODO: Implémenter l'édition (pour l'instant juste supprimer et re-ajouter)
                alert('✏️ Pour modifier : supprime l\'exercice et ajoute-le à nouveau avec les bonnes valeurs');
            }

            finalizeSession() {
                const nom = document.getElementById('session-name-input').value.trim();
                const type = document.getElementById('session-mobile-input').value;
                
                if (!nom) {
                    alert('⚠️ Entre un nom pour la séance');
                    return;
                }
                
                if (this.exercicesDetails.length === 0) {
                    alert('⚠️ Ajoute au moins un exercice');
                    return;
                }
                
                // Créer la séance avec la nouvelle structure
                const session = {
                    nom,
                    type,
                    exercicesDetails: [...this.exercicesDetails],
                    dateCreation: new Date().toISOString()
                };
                
                // Sauvegarder
                if (this.currentSession !== null) {
                    this.sessions[this.currentSession] = session;
                    console.log('✏️ Séance modifiée');
                } else {
                    this.sessions.push(session);
                    console.log('➕ Nouvelle séance créée');
                }
                
                this.saveSessions();
                this.checkBadges();
                
                // Réinitialiser
                this.currentSession = null;
                this.exercicesDetails = [];
                
                // Retour au dashboard
                this.currentView = 'dashboard';
                this.currentTab = 'sessions';
                this.render();
                
                console.log('✅ Séance sauvegardée avec succès !');
            }

            cancelSession() {
                if (this.exercicesDetails && this.exercicesDetails.length > 0) {
                    if (!confirm('Tu as des exercices non sauvegardés. Quitter quand même ?')) {
                        return;
                    }
                }
                this.currentSession = null;
                this.exercicesDetails = [];
                this.sessionStep = 1;
                this.sessionNomTemp = '';
                this.sessionMobileTemp = 'Hypertrophie';
                this.currentView = 'dashboard';
                this.currentTab = 'sessions';
                this.render();
            }

            createNewSession() {
                this.currentSession = null;
                this.exercicesDetails = [];
                this.sessionStep = 1;
                this.sessionNomTemp = '';
                this.sessionMobileTemp = 'Hypertrophie';
                this.currentView = 'session-form';
                this.render();
            }

            editSession(index) {
                this.currentSession = index;
                const session = this.sessions[index];
                
                // Charger les exercices détaillés si nouvelle structure
                if (session.exercicesDetailles) {
                    this.exercicesDetaillesTemp = [...session.exercicesDetailles];
                } else {
                    // Ancienne structure - pour compatibilité
                    this.exercicesTemp = [...(session.exercices || [])];
                    this.musclesTemp = [...(session.muscles || [])];
                }
                
                this.currentView = 'session-form';
                this.render();
            }
            
            toggleExerciceTermine(indexExercice) {
                const session = this.sessions[this.currentSession];
                if (!session || !session.exercicesDetailles) return;
                
                // Toggle le statut
                session.exercicesDetailles[indexExercice].termine = !session.exercicesDetailles[indexExercice].termine;
                
                // Sauvegarder
                this.saveSessions();
                
                // Recharger juste cette partie (pas tout)
                this.render();
                
                console.log(`Exercice ${indexExercice} marqué comme ${session.exercicesDetailles[indexExercice].termine ? 'terminé' : 'non terminé'}`);
            }

            deleteSession(index) {
                if (confirm('Supprimer cette séance ?')) {
                    this.sessions.splice(index, 1);
                    this.saveSessions();
                    this.render();
                }
            }

            viewSession(index) {
                this.currentSession = index;
                this.currentView = 'session-detail';
                this.render();
            }

            backToSessions() {
                this.currentSession = null;
                this.currentView = 'dashboard';
                this.currentTab = 'sessions';
                this.render();
            }

            toggleMuscle(muscle) {
                const index = this.musclesTemp.indexOf(muscle);
                if (index > -1) this.musclesTemp.splice(index, 1);
                else this.musclesTemp.push(muscle);
                this.render();
            }

            addExercice() {
                const input = document.getElementById('exercice-name');
                if (!input) {
                    console.error('Input exercice-name non trouvé');
                    return;
                }
                
                const exerciceName = input.value.trim();
                if (!exerciceName) {
                    alert('⚠️ Entrez le nom d\'un exercice');
                    return;
                }
                
                // Vérifier les doublons
                if (this.exercicesTemp.includes(exerciceName)) {
                    alert('⚠️ Cet exercice est déjà dans la liste');
                    input.value = '';
                    return;
                }
                
                this.exercicesTemp.push(exerciceName);
                input.value = '';
                input.focus(); // Remettre le focus pour ajouter rapidement le suivant
                this.render();
                
                console.log('✅ Exercice ajouté:', exerciceName, '- Total:', this.exercicesTemp.length);
            }

            removeExercice(index) {
                this.exercicesTemp.splice(index, 1);
                this.render();
            }

            saveSession(e) {
                e.preventDefault();
                
                console.log('🔄 Sauvegarde de la séance...');
                console.log('Muscles:', this.musclesTemp);
                console.log('Exercices:', this.exercicesTemp);
                
                const nom = document.getElementById("session-name").value.trim();
                const type = document.getElementById("session-type").value;
                const series = parseInt(document.getElementById("session-series").value) || 5;
                const repetitions = parseInt(document.getElementById("session-repetitions").value) || 5;
                const intensite = parseInt(document.getElementById("session-intensite").value) || 90;
                const repos = parseInt(document.getElementById("session-repos").value) || 180;
                const isPersonnalise = document.getElementById("mode-personnalise")?.checked || type === "Personnalisé";
                
                if (!nom) {
                    alert("⚠️ Entrez un nom pour la séance");
                    return;
                }
                
                if (this.musclesTemp.length === 0) {
                    alert("⚠️ Sélectionnez au moins un muscle");
                    return;
                }
                
                if (this.exercicesTemp.length === 0) {
                    alert("⚠️ Ajoutez au moins un exercice");
                    return;
                }
                
                const sessionData = {
                    nom, 
                    type, 
                    muscles: [...this.musclesTemp], 
                    exercices: [...this.exercicesTemp],
                    series,
                    repetitions,
                    intensite,
                    repos,
                    isPersonnalise
                };
                
                console.log('💾 Données de la séance:', sessionData);
                
                if (this.currentSession !== null) {
                    this.sessions[this.currentSession] = sessionData;
                    console.log('✏️ Séance modifiée à l\'index', this.currentSession);
                } else {
                    this.sessions.push(sessionData);
                    console.log('➕ Nouvelle séance ajoutée, total:', this.sessions.length);
                }
                
                this.saveSessions();
                this.checkBadges();
                
                // Réinitialiser
                this.currentSession = null;
                this.exercicesTemp = [];
                this.musclesTemp = [];
                
                // Retour au dashboard avec onglet séances
                this.currentView = "dashboard";
                this.currentTab = "sessions";
                this.render();
                
                console.log('✅ Séance sauvegardée avec succès !');
            }

            initSessionForm() {
                const isEditing = this.currentSession !== null;
                const session = isEditing ? this.sessions[this.currentSession] : {muscles: [], exercices: []};
                this.musclesTemp = [...session.muscles];
                this.exercicesTemp = [...session.exercices];
            }

            markSessionCompleted() {
                const notes = document.getElementById('session-notes').value.trim();
                const historyEntry = {
                    sessionIndex: this.currentSession,
                    completed: true,
                    completedAt: new Date().toISOString(),
                    notes: notes
                };
                this.sessionHistory.push(historyEntry);
                this.saveSessionHistory();
                this.checkBadges();
                this.calculateStreaks();
                this.updateObjectifProgress();
                alert('✅ Séance validée !');
                this.backToSessions();
            }

            exportData() {
                const data = {
                    sessions: this.sessions,
                    rmHistory: this.rmHistory,
                    avatar: this.userAvatar,
                    sessionHistory: this.sessionHistory,
                    calculatedCharges: this.calculatedCharges,
                    theme: this.currentTheme,
                    badges: this.badges,
                    userData: JSON.parse(localStorage.getItem(`user-${this.currentUser}`))
                };
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `livret-${this.currentUser}-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
            }

            importData() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            if (data.sessions) this.sessions = data.sessions;
                            if (data.rmHistory) this.rmHistory = data.rmHistory;
                            if (data.avatar) this.userAvatar = data.avatar;
                            if (data.sessionHistory) this.sessionHistory = data.sessionHistory;
                            if (data.calculatedCharges) this.calculatedCharges = data.calculatedCharges;
                            if (data.theme) {
                                this.currentTheme = data.theme;
                                this.applyTheme(data.theme);
                            }
                            if (data.badges) this.badges = data.badges;
                            if (data.userData) {
                                localStorage.setItem(`user-${this.currentUser}`, JSON.stringify(data.userData));
                            }
                            this.saveSessions();
                            this.saveRMHistory();
                            this.saveUserAvatar();
                            this.saveSessionHistory();
                            this.saveCalculatedCharges();
                            this.saveTheme();
                            this.saveBadges();
                            alert('✅ Données importées !');
                            this.render();
                        } catch (error) {
                            alert('❌ Erreur lors de l\'importation');
                        }
                    };
                    reader.readAsText(file);
                };
                input.click();
            }

            handleCodeAccess(e) {
                e.preventDefault();
                const code = document.getElementById('code-input').value;
                if (securite.verifierCode(code)) {
                    securite.validerCode();
                    this.currentView = 'login';
                    this.render();
                } else {
                    document.getElementById('code-error').classList.remove('hidden');
                    document.getElementById('code-input').value = '';
                    document.getElementById('code-input').focus();
                }
            }

            submitCode() {
                const code = document.getElementById('code-input').value;
                if (securite.verifierCode(code)) {
                    securite.validerCode();
                    this.currentView = 'login';
                    this.render();
                } else {
                    document.getElementById('code-error').classList.remove('hidden');
                    document.getElementById('code-input').value = '';
                    document.getElementById('code-input').focus();
                }
            }

            showSignup() {
                this.currentView = 'signup';
                this.render();
            }

            selectUser(username) {
                this.currentUser = username;
                this.loadUserData();
                this.currentView = 'dashboard';
                this.currentTab = 'dashboard';
                this.render();
            }

            handleSelectUser() {
                const select = document.getElementById('select-user');
                const username = select.value;
                if (!username) {
                    alert('⚠️ Sélectionne un profil');
                    return;
                }
                this.selectUser(username);
            }

            showLogin() {
                this.currentView = 'login';
                this.render();
            }

            submitSignup() {
                const username = document.getElementById('signup-username').value.trim();
                const age = parseInt(document.getElementById('signup-age').value);
                const sexe = document.getElementById('signup-sexe').value;
                const taille = parseInt(document.getElementById('signup-taille').value);
                const poids = parseFloat(document.getElementById('signup-poids').value);

                // Validation
                if (!username) {
                    alert('⚠️ Entre ton prénom');
                    return;
                }
                if (!age || age < 10 || age > 100) {
                    alert('⚠️ Entre un âge valide');
                    return;
                }
                if (!sexe) {
                    alert('⚠️ Sélectionne ton sexe');
                    return;
                }
                if (!taille || taille < 100 || taille > 250) {
                    alert('⚠️ Entre une taille valide (cm)');
                    return;
                }
                if (!poids || poids < 30 || poids > 200) {
                    alert('⚠️ Entre un poids valide (kg)');
                    return;
                }

                // Créer le profil
                this.currentUser = username;
                const userData = { age, sexe, taille, poids };
                const userKey = `user-${username}`;
                storage.save(userKey, JSON.stringify(userData), true);

                // Charger les données
                this.loadUserData();
                
                // Aller au dashboard
                this.currentView = 'dashboard';
                this.currentTab = 'dashboard';
                this.render();

                console.log('✅ Profil créé:', username);
            }

            // ========== FONCTIONS DE NAVIGATION ==========
            
            switchTab(tab) {
                this.currentTab = tab;
                this.render();
            }

            switchCoursTab(tab) {
                this.currentCoursTab = tab;
                this.render();
            }

            logout() {
                const message = 'Que voulez-vous faire ?\n\n' +
                               '✅ OK = Changer de profil (garder le code de classe)\n' +
                               '❌ Annuler = Verrouiller complètement (redemander le code)';
                
                if (confirm(message)) {
                    this.currentView = 'login';
                } else {
                    securite.revoquerAcces();
                    IS_COACH_MODE = false;
                    this.currentView = 'code-access';
                }
                
                this.currentUser = null;
                this.sessions = [];
                this.rmHistory = [];
                this.userAvatar = null;
                this.sessionHistory = [];
                this.calculatedCharges = {};
                this.badges = [];
                this.objectifs = [];
                this.currentStreak = 0;
                this.longestStreak = 0;
                
                this.render();
            }

            // ========== FONCTIONS DE PROFIL ==========

            updateProfile() {
                const age = parseInt(document.getElementById('profile-age').value);
                const taille = parseInt(document.getElementById('profile-taille').value);
                const poids = parseFloat(document.getElementById('profile-poids').value);
                
                if (!age || !taille || !poids) {
                    alert('⚠️ Remplis tous les champs');
                    return;
                }
                
                const userKey = `user-${this.currentUser}`;
                const result = storage.get(userKey, true);
                const userData = result.exists ? JSON.parse(result.value) : {};
                
                userData.age = age;
                userData.taille = taille;
                userData.poids = poids;
                
                storage.save(userKey, JSON.stringify(userData), true);
                this.render();
                
                alert('✅ Profil mis à jour !');
            }

            deletePhoto() {
                if (confirm('Supprimer ta photo de profil ?')) {
                    this.userAvatar = null;
                    this.saveUserAvatar();
                    this.render();
                }
            }

            changeTheme(theme) {
                this.currentTheme = theme;
                document.documentElement.style.setProperty('--primary-color', 
                    theme === 'cyan' ? '#06b6d4' : 
                    theme === 'blue' ? '#3b82f6' : 
                    theme === 'purple' ? '#a855f7' : 
                    theme === 'green' ? '#10b981' : '#06b6d4'
                );
                storage.save('theme', theme);
                this.render();
            }

            // ========== FONCTIONS 1RM ==========

            calculateRM(e) {
                if (e) e.preventDefault();
                
                const muscle = document.getElementById('rm-muscle').value;
                const exercise = document.getElementById('rm-exercise').value.trim();
                const weight = parseFloat(document.getElementById('rm-weight').value);
                const reps = parseInt(document.getElementById('rm-reps').value);
                const dateInput = document.getElementById('rm-date').value;
                
                if (!muscle || !exercise || !weight || !reps || !dateInput) {
                    alert('⚠️ Remplis tous les champs');
                    return;
                }
                
                let rm;
                if (reps === 1) {
                    rm = weight;
                } else if (reps <= 10) {
                    rm = weight * (1 + reps / 30);
                } else {
                    rm = weight * (1 + reps / 25);
                }
                
                rm = Math.round(rm * 10) / 10;
                
                const test = {
                    muscle,
                    exercise,
                    rm,
                    weight,
                    reps,
                    date: new Date(dateInput).toISOString()
                };
                
                this.rmHistory.push(test);
                this.saveRMHistory();
                this.checkBadges();
                
                // Réinitialiser le formulaire
                document.getElementById('rm-muscle').value = '';
                document.getElementById('rm-exercise').value = '';
                document.getElementById('rm-weight').value = '';
                document.getElementById('rm-reps').value = '';
                document.getElementById('rm-date').valueAsDate = new Date();
                
                this.render();
                
                console.log('✅ Test 1RM enregistré:', test);
            }

            editRM(index) {
                this.editingRM = index;
                this.render();
            }

            saveEditRM() {
                // Récupérer l'historique trié pour trouver le bon index original
                const sortedHistory = [...this.rmHistory].sort((a, b) => {
                    if (a.muscle !== b.muscle) return a.muscle.localeCompare(b.muscle);
                    if (a.exercise !== b.exercise) return a.exercise.localeCompare(b.exercise);
                    return new Date(b.date) - new Date(a.date);
                });
                
                const testToEdit = sortedHistory[this.editingRM];
                const originalIndex = this.rmHistory.indexOf(testToEdit);
                
                // Récupérer les nouvelles valeurs
                const muscle = document.getElementById('edit-rm-muscle').value;
                const exercise = document.getElementById('edit-rm-exercise').value.trim();
                const weight = parseFloat(document.getElementById('edit-rm-weight').value);
                const reps = parseInt(document.getElementById('edit-rm-reps').value);
                const date = document.getElementById('edit-rm-date').value;
                
                if (!muscle || !exercise || !weight || !reps || !date) {
                    alert('⚠️ Remplis tous les champs');
                    return;
                }
                
                // Recalculer le 1RM
                let rm;
                if (reps === 1) {
                    rm = weight;
                } else if (reps <= 10) {
                    rm = weight * (1 + reps / 30);
                } else {
                    rm = weight * (1 + reps / 25);
                }
                rm = Math.round(rm * 10) / 10;
                
                // Mettre à jour le test
                this.rmHistory[originalIndex] = {
                    muscle,
                    exercise,
                    weight,
                    reps,
                    rm,
                    date: new Date(date).toISOString()
                };
                
                this.saveRMHistory();
                this.editingRM = null;
                this.render();
                
                alert('✅ Test modifié avec succès !');
            }

            cancelEditRM() {
                this.editingRM = null;
                this.render();
            }

            deleteRM(index) {
                if (confirm('Supprimer ce test ?')) {
                    // Récupérer l'historique trié pour trouver le bon index original
                    const sortedHistory = [...this.rmHistory].sort((a, b) => {
                        if (a.muscle !== b.muscle) return a.muscle.localeCompare(b.muscle);
                        if (a.exercise !== b.exercise) return a.exercise.localeCompare(b.exercise);
                        return new Date(b.date) - new Date(a.date);
                    });
                    
                    const testToDelete = sortedHistory[index];
                    const originalIndex = this.rmHistory.indexOf(testToDelete);
                    
                    this.rmHistory.splice(originalIndex, 1);
                    this.saveRMHistory();
                    this.checkBadges();
                    this.render();
                }
            }

            calculateCharges() {
                const select = document.getElementById('charges-rm-select');
                const index = parseInt(select.value);
                if (isNaN(index)) {
                    this.calculatedCharges = {};
                } else {
                    const test = this.rmHistory[index];
                    this.calculatedCharges = {
                        exercise: test.exercise, 
                        rm: test.rm,
                        selectedIndex: index
                    };
                    this.saveCalculatedCharges();
                }
                this.render();
            }

            updatePercentage(value) {
                this.selectedPercentage = parseInt(value);
                const percentageDisplay = document.querySelector('.text-cyan[style*="font-size: 2.5rem"]');
                const chargeDisplay = percentageDisplay ? percentageDisplay.nextElementSibling : null;
                
                if (percentageDisplay && chargeDisplay && this.calculatedCharges.rm) {
                    percentageDisplay.textContent = `${this.selectedPercentage}%`;
                    chargeDisplay.textContent = `${Math.round(this.calculatedCharges.rm * this.selectedPercentage / 100)} kg`;
                    
                    const rows = document.querySelectorAll('.charges-table tbody tr');
                    const ranges = [
                        [85, 100], [30, 60], [65, 80], [60, 75], [40, 60], [10, 120]
                    ];
                    
                    rows.forEach((row, index) => {
                        const [min, max] = ranges[index];
                        if (this.selectedPercentage >= min && this.selectedPercentage <= max) {
                            row.style.background = row.children[0].style.color.replace('rgb', 'rgba').replace(')', ', 0.2)');
                        } else {
                            row.style.background = 'transparent';
                        }
                    });
                }
            }

            // ========== FONCTIONS COURS ==========

            updateSearchQuery() {
                this.searchQuery = document.getElementById('search-input').value.toLowerCase();
                this.render();
            }

            toggleFilter(muscle) {
                const index = this.activeFilters.indexOf(muscle);
                if (index > -1) {
                    this.activeFilters.splice(index, 1);
                } else {
                    this.activeFilters.push(muscle);
                }
                this.render();
            }

            // ========== FONCTIONS TIMER ==========

            setTimerMode(mode) {
                this.timerMode = mode;
                this.render();
            }

            // ========== FONCTIONS RENDER MANQUANTES ==========

            renderProfilTab() {
                const userKey = `user-${this.currentUser}`;
                const result = storage.get(userKey, true);
                const userData = result.exists ? JSON.parse(result.value) : {};
                
                return `
                    <div>
                        <h2 class="text-white mb-4" style="font-size: 1.5rem;">👤 Mon Profil</h2>
                        <div class="profile-section">
                            <div class="text-center mb-4">
                                ${this.userAvatar ? 
                                    `<img src="${this.userAvatar}" class="profile-avatar-large" alt="Avatar" style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; margin: 0 auto;">
                                     <button class="btn btn-danger mt-2" onclick="app.deletePhoto()">🗑️ Supprimer</button>` 
                                    : `<div class="default-avatar-large" style="width: 120px; height: 120px; font-size: 4rem; margin: 0 auto;">👤</div>`
                                }
                            </div>
                            <div class="mb-3">
                                <label class="text-white mb-1" style="display: block; font-weight: 600;">Prénom</label>
                                <input type="text" class="input" value="${this.currentUser}" disabled>
                            </div>
                            <div class="grid grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">Âge</label>
                                    <input type="number" class="input" id="profile-age" value="${userData.age || ''}" min="10" max="100">
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">Taille (cm)</label>
                                    <input type="number" class="input" id="profile-taille" value="${userData.taille || ''}" min="100" max="250">
                                </div>
                                <div>
                                    <label class="text-white mb-1" style="display: block; font-weight: 600;">Poids (kg)</label>
                                    <input type="number" class="input" id="profile-poids" value="${userData.poids || ''}" min="30" max="200" step="0.1">
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="app.updateProfile()" style="width: 100%;">💾 Sauvegarder</button>
                        </div>
                    </div>
                `;
            }

            renderSessionDetail() {
                const session = this.sessions[this.currentSession];
                if (!session) return '';
                
                const exercicesDetails = session.exercicesDetails || [];
                
                if (exercicesDetails.length === 0) {
                    return `
                        <div class="container">
                            <div class="card">
                                <button class="btn btn-secondary mb-4" onclick="app.cancelSession()">← Retour</button>
                                <div class="text-center" style="padding: 3rem;">
                                    <div style="font-size: 4rem; margin-bottom: 1rem;">⚠️</div>
                                    <div class="text-white">Cette séance utilise l'ancien format</div>
                                    <div class="text-white" style="opacity: 0.7; margin-top: 0.5rem;">Recréez-la avec le nouveau système</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Récupérer l'historique de cette séance
                const sessionHistory = this.sessionHistory.filter(h => h.sessionIndex === this.currentSession);
                const hasHistory = sessionHistory.length > 0;
                
                return `
                    <div class="container">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-white" style="font-size: 1.5rem;">${session.nom}</h2>
                                <button class="btn btn-secondary" onclick="app.cancelSession()">← Retour</button>
                            </div>
                            
                            <div class="text-center mb-4">
                                <span class="badge badge-${session.type.toLowerCase().replace(/ /g, '-')}">${session.type}</span>
                            </div>
                            
                            <!-- Programme de la séance -->
                            <div style="background: rgba(6, 182, 212, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid var(--primary-color);">
                                <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">📋 Programme</h3>
                                ${exercicesDetails.map((ex, i) => `
                                    <div style="background: rgba(15, 23, 42, 0.5); padding: 1rem; border-radius: 0.5rem; margin-bottom: 0.75rem;">
                                        <div class="text-white mb-1" style="font-weight: 600;">${i + 1}. ${ex.nom}</div>
                                        <div class="text-cyan mb-1" style="font-size: 0.9rem;">💪 ${ex.muscle}</div>
                                        <div class="text-white" style="opacity: 0.8; font-size: 0.9rem;">
                                            ${ex.series}×${ex.reps} • ${ex.chargeReelle ? ex.chargeReelle + 'kg' : 'PDC'}
                                            ${ex.tempo ? ' • ' + ex.tempo : ''} • ${ex.recup}s
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Historique des réalisations -->
                            ${hasHistory ? `
                                <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid #a855f7;">
                                    <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">📊 Historique des réalisations (${sessionHistory.length})</h3>
                                    ${sessionHistory.slice().reverse().map((entry, index) => {
                                        const date = new Date(entry.completedAt);
                                        const dateStr = date.toLocaleDateString('fr-FR', { 
                                            day: 'numeric', 
                                            month: 'long', 
                                            year: 'numeric',
                                            hour: '2-digit',
                                            minute: '2-digit'
                                        });
                                        
                                        const isComplete = entry.completed !== false && (!entry.totalExercices || entry.exercicesCompleted === entry.totalExercices);
                                        const completionText = entry.totalExercices 
                                            ? `${entry.exercicesCompleted}/${entry.totalExercices} exercices`
                                            : 'Séance complète';
                                        
                                        // Couleur RPE
                                        const rpeColor = entry.rpe <= 3 ? '#10b981' : 
                                                        entry.rpe <= 6 ? '#fbbf24' : 
                                                        entry.rpe <= 8 ? '#f97316' : '#ef4444';
                                        
                                        return `
                                            <div style="background: rgba(15, 23, 42, 0.6); padding: 1.25rem; border-radius: 0.75rem; margin-bottom: 1rem; border-left: 4px solid ${isComplete ? '#10b981' : '#ffa500'};">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <div class="text-white" style="font-weight: 600; font-size: 1rem;">
                                                            ${isComplete ? '✅' : '⚠️'} ${dateStr}
                                                        </div>
                                                        <div class="text-white" style="opacity: 0.7; font-size: 0.85rem; margin-top: 0.25rem;">
                                                            ${completionText}
                                                        </div>
                                                    </div>
                                                    ${entry.rpe !== null && entry.rpe !== undefined ? `
                                                        <div style="background: ${rpeColor}; padding: 0.5rem 0.75rem; border-radius: 0.5rem; font-weight: 600; color: #0f172a;">
                                                            RPE ${entry.rpe}/10
                                                        </div>
                                                    ` : ''}
                                                </div>
                                                
                                                ${entry.notes ? `
                                                    <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.75rem;">
                                                        <div class="text-cyan" style="font-size: 0.85rem; font-weight: 600; margin-bottom: 0.25rem;">📝 Notes :</div>
                                                        <div class="text-white" style="opacity: 0.9; font-size: 0.9rem; font-style: italic;">"${entry.notes}"</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : `
                                <div style="background: rgba(255, 165, 0, 0.1); padding: 2rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px dashed #ffa500; text-align: center;">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">📊</div>
                                    <div class="text-white mb-2" style="font-size: 1.1rem; font-weight: 600;">Aucune réalisation</div>
                                    <div class="text-white" style="opacity: 0.7; font-size: 0.9rem;">Cette séance n'a jamais été effectuée</div>
                                </div>
                            `}
                            
                            <!-- Bouton démarrer -->
                            <button class="btn btn-success" onclick="app.startSession()" style="width: 100%; font-size: 1.1rem; padding: 1rem;">
                                🏋️ ${hasHistory ? 'Refaire cette séance' : 'Démarrer la séance'}
                            </button>
                        </div>
                    </div>
                `;
            }

            startSession() {
                this.currentView = 'session-live';
                this.render();
            }

            renderSessionLive() {
                const session = this.sessions[this.currentSession];
                if (!session || !session.exercicesDetails) return '';
                
                const exercicesDetails = session.exercicesDetails;
                const completedCount = exercicesDetails.filter(e => e.completed).length;
                const totalCount = exercicesDetails.length;
                const progressPercent = Math.round((completedCount / totalCount) * 100);
                
                return `
                    <div class="container">
                        <div class="card">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-white" style="font-size: 1.5rem;">🏋️ ${session.nom}</h2>
                                <button class="btn btn-secondary" onclick="app.endSessionLive()">← Retour</button>
                            </div>
                            
                            <!-- Timer intégré -->
                            <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid #a855f7;">
                                <div class="text-white mb-2" style="font-weight: 600; font-size: 1.1rem;">⏱️ Timer de repos</div>
                                <div class="timer-display ${this.timerRunning ? 'running' : ''} ${this.timerSeconds === 0 ? 'finished' : ''}" id="timer-display" style="font-size: 3rem; text-align: center; margin: 1rem 0; font-weight: 700; font-family: 'Courier New', monospace; color: ${this.timerSeconds === 0 ? '#ef4444' : 'var(--primary-color)'};">
                                    ${Math.floor(this.timerSeconds / 60).toString().padStart(2, '0')}:${(this.timerSeconds % 60).toString().padStart(2, '0')}
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; justify-content: center;">
                                    <button class="btn ${this.timerSeconds === 30 && !this.timerRunning ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTimerPreset(30)" style="padding: 0.5rem 1rem;">30s</button>
                                    <button class="btn ${this.timerSeconds === 60 && !this.timerRunning ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTimerPreset(60)" style="padding: 0.5rem 1rem;">1min</button>
                                    <button class="btn ${this.timerSeconds === 90 && !this.timerRunning ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTimerPreset(90)" style="padding: 0.5rem 1rem;">1min30</button>
                                    <button class="btn ${this.timerSeconds === 120 && !this.timerRunning ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTimerPreset(120)" style="padding: 0.5rem 1rem;">2min</button>
                                    <button class="btn ${this.timerSeconds === 180 && !this.timerRunning ? 'btn-primary' : 'btn-secondary'}" onclick="app.setTimerPreset(180)" style="padding: 0.5rem 1rem;">3min</button>
                                </div>
                                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                    <button class="btn ${this.timerRunning ? 'btn-warning' : 'btn-success'}" onclick="app.toggleTimer()" style="min-width: 120px; font-size: 1rem; padding: 0.75rem;">
                                        ${this.timerRunning ? '⏸️ Pause' : '▶️ Start'}
                                    </button>
                                    <button class="btn btn-secondary" onclick="app.resetTimer()" style="min-width: 120px; font-size: 1rem; padding: 0.75rem;">
                                        🔄 Reset
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Progression -->
                            <div style="background: rgba(6, 182, 212, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid var(--primary-color);">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="text-white" style="font-weight: 600;">Progression</div>
                                    <div class="text-cyan" style="font-weight: 600; font-size: 1.2rem;">${completedCount} / ${totalCount}</div>
                                </div>
                                <div style="background: rgba(15, 23, 42, 0.5); height: 20px; border-radius: 10px; overflow: hidden;">
                                    <div style="background: var(--primary-color); height: 100%; width: ${progressPercent}%; transition: width 0.3s;"></div>
                                </div>
                                <div class="text-white text-center mt-2" style="opacity: 0.8; font-size: 0.9rem;">${progressPercent}%</div>
                            </div>
                            
                            <!-- Liste des exercices -->
                            ${exercicesDetails.map((ex, index) => `
                                <div style="background: ${ex.completed ? 'rgba(16, 185, 129, 0.2)' : 'rgba(15, 23, 42, 0.5)'}; padding: 1.5rem; border-radius: 1rem; margin-bottom: 1.5rem; border-left: 4px solid ${ex.completed ? '#10b981' : 'var(--primary-color)'}; transition: all 0.3s;">
                                    <div class="flex justify-between items-start mb-3">
                                        <div style="flex: 1;">
                                            <h3 class="text-white mb-1" style="font-size: 1.2rem; font-weight: 600; ${ex.completed ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${index + 1}. ${ex.nom}</h3>
                                            <div class="text-cyan" style="font-size: 0.9rem;">💪 ${ex.muscle}</div>
                                        </div>
                                        <button 
                                            type="button" 
                                            class="btn ${ex.completed ? 'btn-success' : 'btn-primary'}" 
                                            onclick="app.toggleExerciceCompleted(${index})"
                                            style="min-width: 100px;"
                                        >
                                            ${ex.completed ? '✅ Fait' : '⭕ Faire'}
                                        </button>
                                    </div>
                                    
                                    <div style="background: rgba(15, 23, 42, 0.6); padding: 1rem; border-radius: 0.5rem;">
                                        <div class="grid grid-cols-2 gap-2 text-white" style="font-size: 0.95rem;">
                                            <div><strong>Séries ×Reps:</strong> ${ex.series} × ${ex.reps}</div>
                                            <div><strong>Charge:</strong> ${ex.chargeReelle ? ex.chargeReelle + ' kg' : 'PDC'}</div>
                                            ${ex.tempo ? `<div><strong>Tempo:</strong> ${ex.tempo}</div>` : ''}
                                            <div><strong>Récup:</strong> ${ex.recup}s</div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                            
                            <!-- Boutons de fin -->
                            <div style="background: ${completedCount === totalCount ? 'rgba(16, 185, 129, 0.2)' : 'rgba(255, 165, 0, 0.1)'}; padding: 2rem; border-radius: 1rem; text-align: center; border: 2px solid ${completedCount === totalCount ? '#10b981' : '#ffa500'};">
                                ${completedCount === totalCount ? `
                                    <div style="font-size: 3rem; margin-bottom: 1rem;">🎉</div>
                                    <h3 class="text-white mb-3" style="font-size: 1.3rem;">Tous les exercices terminés !</h3>
                                ` : `
                                    <div style="font-size: 2.5rem; margin-bottom: 1rem;">⚠️</div>
                                    <h3 class="text-white mb-3" style="font-size: 1.2rem;">Séance incomplète (${completedCount}/${totalCount})</h3>
                                    <div class="text-white mb-3" style="opacity: 0.8; font-size: 0.9rem;">Blessure, manque de temps ? Pas de problème !</div>
                                `}
                                <button class="btn btn-success" onclick="app.showSessionBilan()" style="width: 100%; max-width: 350px; font-size: 1.1rem; padding: 1rem;">
                                    📝 ${completedCount === totalCount ? 'Faire le bilan et valider' : 'Terminer et faire le bilan'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            toggleExerciceCompleted(index) {
                const session = this.sessions[this.currentSession];
                if (!session || !session.exercicesDetails) return;
                
                // Toggle le statut
                session.exercicesDetails[index].completed = !session.exercicesDetails[index].completed;
                
                // Sauvegarder immédiatement
                this.saveSessions();
                
                // Recharger
                this.render();
                
                console.log(`✅ Exercice ${index + 1} ${session.exercicesDetails[index].completed ? 'terminé' : 'non terminé'}`);
            }

            showSessionBilan() {
                this.currentView = 'session-bilan';
                this.render();
            }

            renderSessionBilan() {
                const session = this.sessions[this.currentSession];
                if (!session || !session.exercicesDetails) return '';
                
                const completedCount = session.exercicesDetails.filter(e => e.completed).length;
                const totalCount = session.exercicesDetails.length;
                const isComplete = completedCount === totalCount;
                
                return `
                    <div class="container">
                        <div class="card">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-white" style="font-size: 1.5rem;">📝 Bilan de séance</h2>
                                <button class="btn btn-secondary" onclick="app.backToSessionLive()">← Retour</button>
                            </div>
                            
                            <!-- Résumé de la séance -->
                            <div style="background: rgba(6, 182, 212, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid var(--primary-color);">
                                <h3 class="text-cyan mb-3" style="font-size: 1.2rem;">${session.nom}</h3>
                                <div class="text-white mb-2" style="font-size: 1rem;">
                                    <strong>Exercices réalisés :</strong> ${completedCount} / ${totalCount} 
                                    ${isComplete ? '✅' : '⚠️'}
                                </div>
                                <div class="text-white" style="opacity: 0.8; font-size: 0.9rem;">
                                    ${isComplete ? '🎉 Séance complète' : '⚠️ Séance incomplète'}
                                </div>
                            </div>
                            
                            <!-- RPE (Rate of Perceived Exertion) -->
                            <div style="background: rgba(168, 85, 247, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid #a855f7;">
                                <h3 class="text-white mb-3" style="font-size: 1.2rem;">💪 RPE - Perception de l'effort</h3>
                                <div class="text-white mb-3" style="opacity: 0.8; font-size: 0.9rem;">
                                    Comment as-tu trouvé la séance ?
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(11, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                                    ${[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rpe => `
                                        <label style="cursor: pointer;">
                                            <input 
                                                type="radio" 
                                                name="rpe" 
                                                value="${rpe}" 
                                                id="rpe-${rpe}"
                                                style="display: none;"
                                                onchange="app.selectRPE(${rpe})"
                                            >
                                            <div 
                                                id="rpe-btn-${rpe}"
                                                style="
                                                    background: rgba(255,255,255,0.1); 
                                                    padding: 0.75rem 0.5rem; 
                                                    text-align: center; 
                                                    border-radius: 0.5rem; 
                                                    border: 2px solid transparent;
                                                    transition: all 0.2s;
                                                    font-weight: 600;
                                                "
                                                class="text-white"
                                            >
                                                ${rpe}
                                            </div>
                                        </label>
                                    `).join('')}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; margin-top: 1rem;">
                                    <div class="text-white" style="opacity: 0.7; font-size: 0.85rem;">😌 Très facile</div>
                                    <div class="text-white" style="opacity: 0.7; font-size: 0.85rem;">💀 Extrêmement difficile</div>
                                </div>
                                
                                <div id="rpe-description" class="text-cyan" style="margin-top: 1rem; text-align: center; font-size: 0.95rem; min-height: 1.5rem;"></div>
                            </div>
                            
                            <!-- Notes -->
                            <div style="background: rgba(16, 185, 129, 0.1); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 2px solid #10b981;">
                                <h3 class="text-white mb-3" style="font-size: 1.2rem;">📋 Notes (optionnel)</h3>
                                <div class="text-white mb-2" style="opacity: 0.8; font-size: 0.9rem;">
                                    Ressenti, difficultés, points positifs...
                                </div>
                                <textarea 
                                    class="input" 
                                    id="session-notes" 
                                    placeholder="Ex: Bonnes sensations sur le développé couché. Épaule gauche un peu douloureuse sur les écartés. À surveiller." 
                                    rows="5"
                                    style="resize: vertical;"
                                ></textarea>
                            </div>
                            
                            <!-- Validation -->
                            <button 
                                class="btn btn-success" 
                                onclick="app.finalizeSessionBilan()" 
                                style="width: 100%; font-size: 1.2rem; padding: 1rem;"
                            >
                                ✅ Valider et enregistrer la séance
                            </button>
                        </div>
                    </div>
                `;
            }

            selectRPE(rpe) {
                // Désélectionner tous
                for (let i = 0; i <= 10; i++) {
                    const btn = document.getElementById(`rpe-btn-${i}`);
                    if (btn) {
                        btn.style.background = 'rgba(255,255,255,0.1)';
                        btn.style.borderColor = 'transparent';
                    }
                }
                
                // Sélectionner celui cliqué
                const selectedBtn = document.getElementById(`rpe-btn-${rpe}`);
                if (selectedBtn) {
                    selectedBtn.style.background = 'var(--primary-color)';
                    selectedBtn.style.borderColor = 'var(--primary-color)';
                    selectedBtn.style.color = '#0f172a';
                }
                
                // Afficher la description
                const descriptions = {
                    0: '😴 Repos complet',
                    1: '😌 Très très facile',
                    2: '😊 Facile',
                    3: '🙂 Modéré',
                    4: '😐 Un peu difficile',
                    5: '😅 Difficile',
                    6: '😓 Plus difficile',
                    7: '😰 Très difficile',
                    8: '😵 Extrêmement difficile',
                    9: '💀 Presque maximal',
                    10: '🔥 Effort maximal absolu'
                };
                
                const descDiv = document.getElementById('rpe-description');
                if (descDiv) {
                    descDiv.textContent = descriptions[rpe];
                }
            }

            finalizeSessionBilan() {
                const session = this.sessions[this.currentSession];
                const completedCount = session.exercicesDetails.filter(e => e.completed).length;
                
                // Récupérer RPE
                const rpeInput = document.querySelector('input[name="rpe"]:checked');
                const rpe = rpeInput ? parseInt(rpeInput.value) : null;
                
                if (rpe === null) {
                    alert('⚠️ Indique ton RPE (perception de l\'effort)');
                    return;
                }
                
                // Récupérer notes
                const notes = document.getElementById('session-notes').value.trim();
                
                // Ajouter à l'historique
                const historyEntry = {
                    sessionIndex: this.currentSession,
                    completed: completedCount === session.exercicesDetails.length,
                    completedAt: new Date().toISOString(),
                    exercicesCompleted: completedCount,
                    totalExercices: session.exercicesDetails.length,
                    rpe: rpe,
                    notes: notes
                };
                
                this.sessionHistory.push(historyEntry);
                this.saveSessionHistory();
                this.checkBadges();
                this.updateStreak();
                
                // Réinitialiser les états completed pour la prochaine fois
                session.exercicesDetails.forEach(ex => ex.completed = false);
                this.saveSessions();
                
                // Retour aux séances
                this.currentView = 'dashboard';
                this.currentTab = 'sessions';
                this.render();
                
                alert('✅ Séance enregistrée avec succès ! Bien joué ! 💪');
            }

            backToSessionLive() {
                this.currentView = 'session-live';
                this.render();
            }

            endSessionLive() {
                const session = this.sessions[this.currentSession];
                const completedCount = session.exercicesDetails.filter(e => e.completed).length;
                
                if (completedCount > 0 && completedCount < session.exercicesDetails.length) {
                    if (!confirm('Tu n\'as pas terminé tous les exercices. Quitter quand même ?')) {
                        return;
                    }
                }
                
                this.currentView = 'session-detail';
                this.render();
            }

            attachCodeAccessEvents() {
                const form = document.getElementById('code-form');
                if (form) form.addEventListener('submit', (e) => this.handleCodeAccess(e));
            }

            attachLoginEvents() {}

            attachSignupEvents() {
                const form = document.getElementById('signup-form');
                if (form) form.addEventListener('submit', (e) => this.handleSignup(e));
                const avatarInput = document.getElementById('avatar-input');
                if (avatarInput) {
                    avatarInput.addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                document.getElementById('avatar-preview').innerHTML = `<img src="${event.target.result}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">`;
                                this.userAvatar = event.target.result;
                            };
                            reader.readAsDataURL(file);
                        }
                    });
                }
            }

            attachDashboardEvents() {
                if (this.currentTab === 'profil') {
                    const form = document.getElementById('profile-form');
                    if (form) form.addEventListener('submit', (e) => this.updateProfile(e));
                    const avatarInput = document.getElementById('profile-avatar-input');
                    if (avatarInput) {
                        avatarInput.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (file) {
                                const reader = new FileReader();
                                reader.onload = (event) => {
                                    this.userAvatar = event.target.result;
                                    this.saveUserAvatar();
                                    this.render();
                                };
                                reader.readAsDataURL(file);
                            }
                        });
                    }
                }
                if (this.currentTab === 'rm') {
                    const form = document.getElementById('rm-form');
                    if (form) form.addEventListener('submit', (e) => this.calculateRM(e));
                    const dateInput = document.getElementById('rm-date');
                    if (dateInput && !dateInput.value) dateInput.valueAsDate = new Date();
                }
            }

            attachSessionFormEvents() {
                this.initSessionForm();
                const form = document.getElementById('session-form');
                if (form) form.addEventListener('submit', (e) => this.saveSession(e));
                const exerciceInput = document.getElementById('exercice-name');
                if (exerciceInput) {
                    exerciceInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.addExercice();
                        }
                    });
                }
            }

            attachSessionDetailEvents() {}

            setTimerPreset(seconds) {
                this.timerSeconds = seconds;
                this.timerRunning = false;
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                this.render();
            }

            setCustomTimer() {
                const minutes = parseInt(document.getElementById('custom-minutes').value) || 0;
                const seconds = parseInt(document.getElementById('custom-seconds').value) || 0;
                this.timerSeconds = minutes * 60 + seconds;
                this.timerRunning = false;
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
                this.render();
            }

            toggleTimer() {
                if (this.timerRunning) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                    this.timerRunning = false;
                } else {
                    this.timerRunning = true;
                    this.timerInterval = setInterval(() => {
                        if (this.timerSeconds > 0) {
                            this.timerSeconds--;
                            this.updateTimerDisplay();
                        } else {
                            this.timerFinished();
                        }
                    }, 1000);
                }
                this.render();
            }

            updateTimerDisplay() {
                const display = document.getElementById('timer-display');
                if (display) {
                    const minutes = Math.floor(this.timerSeconds / 60);
                    const seconds = this.timerSeconds % 60;
                    display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    if (this.timerSeconds === 0) display.classList.add('finished');
                }
            }

            timerFinished() {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
                this.timerRunning = false;
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance('Repos terminé');
                    utterance.lang = 'fr-FR';
                    utterance.rate = 1.2;
                    speechSynthesis.speak(utterance);
                }
                if ('vibrate' in navigator) navigator.vibrate([200, 100, 200]);
                this.render();
            }

            resetTimer() {
                clearInterval(this.timerInterval);
                this.timerInterval = null;
                this.timerRunning = false;
                this.timerSeconds = 60;
                this.render();
            }

            toggleChrono() {
                if (this.chronoRunning) {
                    clearInterval(this.chronoInterval);
                    this.chronoInterval = null;
                    this.chronoRunning = false;
                } else {
                    this.chronoRunning = true;
                    this.chronoInterval = setInterval(() => {
                        this.chronoSeconds++;
                        this.updateChronoDisplay();
                    }, 1000);
                }
                this.render();
            }

            updateChronoDisplay() {
                const display = document.getElementById('chrono-display');
                if (display) {
                    const minutes = Math.floor(this.chronoSeconds / 60);
                    const seconds = this.chronoSeconds % 60;
                    display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }

            addLap() {
                const minutes = Math.floor(this.chronoSeconds / 60);
                const seconds = this.chronoSeconds % 60;
                const lapTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                this.chronoLaps.push(lapTime);
                this.render();
            }

            resetChrono() {
                clearInterval(this.chronoInterval);
                this.chronoInterval = null;
                this.chronoRunning = false;
                this.chronoSeconds = 0;
                this.chronoLaps = [];
                this.render();
            }

            // ===============================================
            // MÉTHODES MODE COACH - Édition de l'historique
            // ===============================================
            
            editHistory(id) {
                if (!IS_COACH_MODE) return;
                this.editingHistoryId = id;
                this.render();
            }

            saveHistoryEdit(id) {
                if (!IS_COACH_MODE) return;
                
                const entry = this.sessionHistory.find(h => h.id === id);
                if (!entry) return;
                
                // Récupérer les valeurs du formulaire
                const newName = document.getElementById('edit-name').value;
                const newType = document.getElementById('edit-type').value;
                const newDate = document.getElementById('edit-date').value;
                const newNotes = document.getElementById('edit-notes').value;
                
                // Mettre à jour l'entrée
                entry.sessionName = newName;
                entry.type = newType;
                entry.completedAt = new Date(newDate).toISOString();
                entry.notes = newNotes;
                
                // Sauvegarder
                this.saveSessionHistory();
                this.editingHistoryId = null;
                this.render();
            }

            cancelHistoryEdit() {
                this.editingHistoryId = null;
                this.render();
            }

            deleteHistory(id) {
                if (!IS_COACH_MODE) return;
                
                if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée de l\'historique ?')) {
                    this.sessionHistory = this.sessionHistory.filter(h => h.id !== id);
                    this.saveSessionHistory();
                    this.render();
                }
            }

            addDemoHistory() {
                if (!IS_COACH_MODE) return;
                
                const demoEntry = {
                    id: Date.now().toString(),
                    sessionName: 'Séance de démonstration',
                    sessionIndex: 0,
                    type: 'Force',
                    completed: true,
                    completedAt: new Date().toISOString(),
                    notes: 'Ceci est une séance d\'exemple ajoutée en mode coach pour tester l\'édition de l\'historique.'
                };
                
                this.sessionHistory.push(demoEntry);
                this.saveSessionHistory();
                this.render();
            }
        }

        let app;
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                app = new LivretApp();
            });
        } else {
            app = new LivretApp();
        }

        // Enregistrement du Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((registration) => {
                        console.log('✅ Service Worker enregistré:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('❌ Échec enregistrement Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>